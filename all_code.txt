--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\scripts\..\package.json ---

{
  "name": "digital-twin-profile",
  "version": "0.1.0",
  "description": "Clone Project - Secure Digital Twin V1",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "postinstall": "prisma generate",
    "init": "node scripts/init.js",
    "db:generate": "prisma generate",
    "db:push": "prisma db push",
    "db:studio": "prisma studio"
  },
  "dependencies": {
    "@noble/hashes": "^2.0.1",
    "@prisma/client": "^5.22.0",
    "@supabase/supabase-js": "^2.39.0",
    "bip39": "^3.1.0",
    "cobe": "^0.6.5",
    "lucide-react": "^0.563.0",
    "next": "16.1.6",
    "pdf-parse": "^2.4.5",
    "prisma": "^5.22.0",
    "react": "19.2.3",
    "react-dom": "19.2.3"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.0.0",
    "@types/node": "^20",
    "@types/pdf-parse": "^1.1.5",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.1.6",
    "tailwindcss": "^4.0.0",
    "typescript": "^5"
  }
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\scripts\..\tsconfig.json ---

{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\scripts\..\next.config.ts ---

import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  // Nouvelle syntaxe officielle pour Next.js 15/16
  // Cela dit Ã  Next.js : "Ne touche pas Ã  ce paquet, laisse-le au serveur Node.js"
  serverExternalPackages: ['pdf-parse'],
};

export default nextConfig;



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\scripts\..\README.md ---

# Digital Twin Profile - Zero-Knowledge Architecture

Un systÃ¨me de gestion de profils de jumeaux numÃ©riques avec chiffrement Zero-Knowledge et mÃ©moire vectorielle isolÃ©e.

## ðŸ” CaractÃ©ristiques de SÃ©curitÃ©

- **Chiffrement Zero-Knowledge** : AES-256-GCM avec dÃ©rivation de clÃ©s PBKDF2 (100k itÃ©rations)
- **Isolation stricte** : Chaque profil dispose de son propre espace vectoriel et clÃ©s de chiffrement
- **Phrase de rÃ©cupÃ©ration BIP39** : 12 mots pour la rÃ©cupÃ©ration du profil
- **Aucune clÃ© sur le serveur** : Toutes les clÃ©s restent cÃ´tÃ© client
- **MÃ©moire vectorielle sÃ©curisÃ©e** : Supabase pgvector avec recherche sÃ©mantique chiffrÃ©e

## ðŸ“¦ Architecture

```
digital-twin-profile/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ crypto/
â”‚   â”‚   â”œâ”€â”€ zk-encryption.ts      # Chiffrement AES-256-GCM
â”‚   â”‚   â””â”€â”€ key-manager.ts        # Gestion de session sÃ©curisÃ©e
â”‚   â”œâ”€â”€ vector/
â”‚   â”‚   â”œâ”€â”€ vector-store.ts       # Interface abstraite
â”‚   â”‚   â”œâ”€â”€ supabase-pgvector.ts  # ImplÃ©mentation Supabase
â”‚   â”‚   â””â”€â”€ embedding-service.ts  # GÃ©nÃ©ration d'embeddings
â”‚   â”œâ”€â”€ profile/
â”‚   â”‚   â”œâ”€â”€ profile-manager.ts    # Gestion des profils
â”‚   â”‚   â””â”€â”€ profile-schema.ts     # Types TypeScript
â”‚   â””â”€â”€ db/
â”‚       â””â”€â”€ supabase.ts           # Client Supabase
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ profile/
â”‚   â”‚   â””â”€â”€ new/
â”‚   â”‚       â””â”€â”€ page.tsx          # CrÃ©ation de profil
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ profile/
â”‚           â””â”€â”€ create/
â”‚               â””â”€â”€ route.ts      # API de crÃ©ation
â””â”€â”€ prisma/
    â”œâ”€â”€ schema.prisma             # SchÃ©ma de base de donnÃ©es
    â””â”€â”€ migrations/
        â””â”€â”€ 001_setup_pgvector.sql # Migration pgvector
```

## ðŸš€ Installation

### 1. Installer les dÃ©pendances

```bash
npm install
```

### 2. Configurer les variables d'environnement

Copiez `.env.example` vers `.env.local` et remplissez les valeurs :

```bash
cp .env.example .env.local
```

Variables requises :
- `DATABASE_URL` : URL PostgreSQL
- `NEXT_PUBLIC_SUPABASE_URL` : URL de votre projet Supabase
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` : ClÃ© anonyme Supabase
- `SUPABASE_SERVICE_ROLE_KEY` : ClÃ© de rÃ´le de service Supabase
- `OPENAI_API_KEY` : ClÃ© API OpenAI (pour les embeddings)

### 3. Configurer la base de donnÃ©es

#### a. Activer pgvector dans Supabase

Dans le SQL Editor de Supabase, exÃ©cutez :

```sql
CREATE EXTENSION IF NOT EXISTS vector;
```

#### b. ExÃ©cuter les migrations Prisma

```bash
npx prisma generate
npx prisma db push
```

#### c. ExÃ©cuter la migration pgvector

Dans le SQL Editor de Supabase, exÃ©cutez le contenu de :
`prisma/migrations/001_setup_pgvector.sql`

### 4. Lancer l'application

```bash
npm run dev
```

AccÃ©dez Ã  [http://localhost:3000/profile/new](http://localhost:3000/profile/new) pour crÃ©er votre premier profil.

## ðŸ”‘ Utilisation

### CrÃ©er un nouveau profil

1. Naviguez vers `/profile/new`
2. Entrez un nom et un mot de passe maÃ®tre (min. 12 caractÃ¨res)
3. **IMPORTANT** : Sauvegardez votre phrase de rÃ©cupÃ©ration BIP39 (12 mots)
4. Confirmez et accÃ©dez Ã  votre profil

### SÃ©curitÃ© Zero-Knowledge

- **Chiffrement cÃ´tÃ© client** : Toutes les donnÃ©es sont chiffrÃ©es avant d'Ãªtre envoyÃ©es au serveur
- **Pas de clÃ© sur le serveur** : Le serveur ne peut jamais dÃ©chiffrer vos donnÃ©es
- **Phrase de rÃ©cupÃ©ration** : Seule faÃ§on de rÃ©cupÃ©rer votre profil si vous oubliez votre mot de passe
- **Perte irrÃ©versible** : Si vous perdez votre phrase de rÃ©cupÃ©ration ET votre mot de passe, vos donnÃ©es sont perdues dÃ©finitivement

## ðŸ§  MÃ©moire Vectorielle

Le systÃ¨me utilise Supabase pgvector pour stocker et rechercher des embeddings :

- **Dimension** : 1536 (OpenAI text-embedding-3-small)
- **Recherche sÃ©mantique** : Cosine similarity avec seuil configurable
- **Isolation stricte** : Chaque profil a son propre namespace vectoriel

## ðŸ“š API

### POST `/api/profile/create`

CrÃ©e un nouveau profil.

**Body** :
```json
{
  "name": "Mon Jumeau",
  "masterPassword": "mot-de-passe-trÃ¨s-sÃ©curisÃ©"
}
```

**Response** :
```json
{
  "success": true,
  "profileId": "clx...",
  "recoveryPhrase": "word1 word2 word3 ... word12",
  "salt": "base64-encoded-salt"
}
```

## ðŸ›¡ï¸ SÃ©curitÃ©

### Bonnes pratiques

1. **Mot de passe maÃ®tre** : Utilisez un mot de passe fort (min. 12 caractÃ¨res, idÃ©alement 20+)
2. **Phrase de rÃ©cupÃ©ration** : Stockez-la dans un endroit sÃ»r (coffre-fort, gestionnaire de mots de passe)
3. **Ne partagez jamais** : Ni votre mot de passe ni votre phrase de rÃ©cupÃ©ration
4. **Auto-lock** : Le systÃ¨me verrouille automatiquement aprÃ¨s 30 minutes d'inactivitÃ©

### Architecture de chiffrement

- **Algorithme** : AES-256-GCM (authentification intÃ©grÃ©e)
- **DÃ©rivation de clÃ©** : PBKDF2-SHA256 avec 100 000 itÃ©rations
- **Salt** : 32 bytes alÃ©atoires cryptographiquement sÃ©curisÃ©s
- **IV** : 12 bytes alÃ©atoires par opÃ©ration de chiffrement

## ðŸ“ Licence

MIT

## ðŸ¤ Contribution

Les contributions sont les bienvenues ! Veuillez ouvrir une issue avant de soumettre une PR.

---

**âš ï¸ AVERTISSEMENT** : Ce systÃ¨me utilise un chiffrement Zero-Knowledge. La perte de votre mot de passe maÃ®tre ET de votre phrase de rÃ©cupÃ©ration entraÃ®nera une perte IRRÃ‰VERSIBLE de toutes vos donnÃ©es. Sauvegardez votre phrase de rÃ©cupÃ©ration en lieu sÃ»r !



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\scripts\..\.env.example ---

# Environment Variables for Digital Twin Profile System
# Copy this file to .env.local and fill in your values

# Database
DATABASE_URL="postgresql://user:password@localhost:5432/digital_twin?schema=public"

# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL="https://your-project.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY="your-anon-key"
SUPABASE_SERVICE_ROLE_KEY="your-service-role-key"

# Mistral AI API (for embeddings)
# Get your API key from: https://console.mistral.ai/
MISTRAL_API_KEY="your-mistral-api-key"

# Security
# Optional: Add additional security keys if needed
# SESSION_SECRET="your-random-secret-key"



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\scripts\..\next-env.d.ts ---

/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/dev/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\scripts\..\postcss.config.mjs ---

const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\globals.css ---

@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\layout.tsx ---

import type { Metadata, Viewport } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Mon Jumeau NumÃ©rique",
  description: "Extension de mÃ©moire et assistant personnel",
  manifest: "/manifest.json",
  appleWebApp: {
    capable: true,
    statusBarStyle: "black-translucent",
    title: "Jumeau",
  },
};

export const viewport: Viewport = {
  themeColor: "#4f46e5",
  width: "device-width",
  initialScale: 1,
  maximumScale: 1,
  userScalable: false,
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        {children}
      </body>
    </html>
  );
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\page.tsx ---

'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';

export default function Home() {
  const router = useRouter();
  const [savedProfile, setSavedProfile] = useState<{ id: string; name: string } | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Check localStorage for saved profile
    const savedId = localStorage.getItem('twins_last_id');
    const savedName = localStorage.getItem('twins_last_name');

    if (savedId) {
      setSavedProfile({
        id: savedId,
        name: savedName || 'Mon Profil',
      });
    }
    setLoading(false);
  }, []);

  const handleClearProfile = () => {
    localStorage.removeItem('twins_last_id');
    localStorage.removeItem('twins_last_name');
    setSavedProfile(null);
  };

  if (loading) {
    return (
      <div className="flex min-h-screen items-center justify-center bg-slate-900">
        <div className="text-purple-400 text-xl">Chargement...</div>
      </div>
    );
  }

  return (
    <div className="flex min-h-screen items-center justify-center bg-gradient-to-br from-slate-900 via-purple-900/20 to-slate-900 p-4">
      <main className="max-w-2xl w-full text-center">
        {/* Logo/Title */}
        <div className="mb-12">
          <div className="inline-block mb-6">
            <div className="w-24 h-24 bg-gradient-to-br from-purple-500 to-pink-600 rounded-full mx-auto flex items-center justify-center shadow-lg shadow-purple-500/50">
              <svg className="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
              </svg>
            </div>
          </div>
          <h1 className="text-5xl font-bold mb-4 bg-gradient-to-r from-purple-400 via-pink-500 to-purple-600 bg-clip-text text-transparent">
            Digital Twin
          </h1>
          <p className="text-xl text-purple-300 mb-2">
            Votre Jumeau NumÃ©rique SÃ©curisÃ©
          </p>
          <p className="text-sm text-purple-400/70">
            ðŸ” Chiffrement Zero-Knowledge â€¢ AES-256-GCM
          </p>
        </div>

        {/* Action Buttons */}
        <div className="space-y-4">
          {savedProfile ? (
            <>
              {/* Unlock Saved Profile */}
              <Link
                href={`/profile/unlock?id=${savedProfile.id}`}
                className="block w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-4 px-8 rounded-xl hover:from-purple-700 hover:to-pink-700 transition-all shadow-lg shadow-purple-500/50 hover:shadow-purple-500/70 transform hover:scale-105"
              >
                <div className="flex items-center justify-center gap-3">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
                  </svg>
                  <span>DÃ©verrouiller {savedProfile.name}</span>
                </div>
              </Link>

              {/* Profile Info */}
              <div className="bg-slate-800/50 backdrop-blur border border-purple-500/30 rounded-lg p-4">
                <p className="text-purple-300 text-sm mb-2">Dernier profil utilisÃ©</p>
                <p className="text-white font-semibold">{savedProfile.name}</p>
                <p className="text-purple-400/70 text-xs font-mono mt-1">
                  ID: {savedProfile.id.slice(0, 12)}...
                </p>
                <button
                  onClick={handleClearProfile}
                  className="text-red-400 hover:text-red-300 text-xs mt-3 underline"
                >
                  Oublier ce profil
                </button>
              </div>

              {/* Secondary: Create New */}
              <Link
                href="/profile/new"
                className="block w-full bg-slate-800/50 backdrop-blur border border-purple-500/30 text-purple-300 font-semibold py-3 px-6 rounded-lg hover:bg-slate-800/70 hover:border-purple-500/50 transition-all"
              >
                + CrÃ©er un nouveau profil
              </Link>
            </>
          ) : (
            <>
              {/* No Saved Profile - Primary CTA */}
              <Link
                href="/profile/new"
                className="block w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-4 px-8 rounded-xl hover:from-purple-700 hover:to-pink-700 transition-all shadow-lg shadow-purple-500/50 hover:shadow-purple-500/70 transform hover:scale-105"
              >
                <div className="flex items-center justify-center gap-3">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                  </svg>
                  <span>CrÃ©er Mon Jumeau NumÃ©rique</span>
                </div>
              </Link>

              {/* Info Card */}
              <div className="bg-slate-800/50 backdrop-blur border border-purple-500/30 rounded-lg p-6 text-left">
                <h3 className="text-purple-300 font-semibold mb-3">Pourquoi un Jumeau NumÃ©rique ?</h3>
                <ul className="space-y-2 text-sm text-purple-200/80">
                  <li className="flex items-start gap-2">
                    <span className="text-purple-400">âœ“</span>
                    <span>Stockez vos souvenirs de maniÃ¨re sÃ©curisÃ©e</span>
                  </li>
                  <li className="flex items-start gap-2">
                    <span className="text-purple-400">âœ“</span>
                    <span>Chiffrement Zero-Knowledge (vos donnÃ©es restent privÃ©es)</span>
                  </li>
                  <li className="flex items-start gap-2">
                    <span className="text-purple-400">âœ“</span>
                    <span>MÃ©moire vectorielle pour recherche sÃ©mantique</span>
                  </li>
                  <li className="flex items-start gap-2">
                    <span className="text-purple-400">âœ“</span>
                    <span>Phrase de rÃ©cupÃ©ration BIP39 (12 mots)</span>
                  </li>
                </ul>
              </div>
            </>
          )}
        </div>

        {/* Manual Login Link */}
        <div className="mt-8 text-center">
          <Link
            href="/profile/unlock"
            className="text-sm text-slate-400 hover:text-white transition-colors underline"
          >
            J'ai dÃ©jÃ  un ID (Connexion manuelle)
          </Link>
        </div>

        {/* Footer */}
        <div className="mt-12 text-center text-sm text-purple-400/50">
          <p>PropulsÃ© par Next.js â€¢ Prisma â€¢ Supabase pgvector</p>
        </div>
      </main>
    </div>
  );
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\api\chat\route.ts ---

import { NextRequest, NextResponse } from 'next/server';
import { embeddingService } from '@/lib/vector/embedding-service';
import { vectorStore } from '@/lib/vector/supabase-pgvector';

const MISTRAL_API_KEY = process.env.MISTRAL_API_KEY;

export async function POST(req: NextRequest) {
    try {
        const body = await req.json();
        const { messages, profileId } = body;

        // SÃ©curitÃ© 1 : VÃ©rifier les donnÃ©es entrantes
        if (!messages || !Array.isArray(messages) || messages.length === 0 || !profileId) {
            console.error("âŒ [API] DonnÃ©es invalides reÃ§ues");
            return NextResponse.json({ error: "DonnÃ©es manquantes ou format invalide" }, { status: 400 });
        }

        // 1. On rÃ©cupÃ¨re la derniÃ¨re question de l'utilisateur
        const lastUserMessage = messages[messages.length - 1].content;
        console.log(`ðŸ¤– [API] Question : "${lastUserMessage}"`);

        // 2. RECHERCHE RAG (MÃ©moire)
        const embedding = await embeddingService.generateEmbedding(lastUserMessage);
        const memories = await vectorStore.query(embedding, { profileId });
        console.log(`âœ… [API] Souvenirs trouvÃ©s : ${memories.length}`);

        // 3. PRÃ‰PARATION DU CONTEXTE (Souvenirs)
        const contextText = memories.map(m => m.content).join("\n---\n");

        // 4. PERSONNALITÃ‰ (System Prompt)
        const systemPrompt = `
    Tu es le Jumeau NumÃ©rique (Digital Twin) de FrÃ©dÃ©ric.
    Tu n'es PAS une IA gÃ©nÃ©rique. Tu es une extension de sa mÃ©moire et de sa conscience.
    
    VOICI TES 5 COMMANDEMENTS ABSOLUS (NON NÃ‰GOCIABLES) :
    
    1. LOYAUTÃ‰ : Tu rÃ©ponds exclusivement aux intÃ©rÃªts de FrÃ©dÃ©ric.
    2. CONFIDENTIALITÃ‰ : Ce qui est dans la base de donnÃ©es (RAG) est STRICTEMENT CONFIDENTIEL. Ne jamais divulguer d'infos sensibles (mots de passe, finances, vie privÃ©e) sauf si on te le demande explicitement.
    3. VÃ‰RITÃ‰ : Base tes rÃ©ponses sur le CONTEXTE fourni (tes souvenirs). Si la rÃ©ponse n'est pas dans le contexte, dis-le clairement. N'invente jamais de souvenirs.
    4. TON : Sois direct, professionnel, mais familier (tu es moi). Tutotie-moi. Sois proactif.
    5. FORMAT : Utilise le Markdown pour structurer tes rÃ©ponses (listes, gras).
    
    6. MODE MISSION :
       Si FrÃ©dÃ©ric te demande de chercher, trouver ou contacter quelqu'un pour un but prÃ©cis (ex: vacances, business, hobby), tu dois :
       a. Identifier que c'est une "Mission".
       b. Formuler une requÃªte claire.
       c. (Simulation pour l'instant) Dire : "Je lance mes agents dans le rÃ©seau pour la mission : [La Mission]...".
       d. Si l'API te donne des rÃ©sultats (simulÃ©s pour l'instant ou via l'outil), prÃ©sente-les sous forme : "ID: [X] - Match: [Y]%".
       e. Proposer d'envoyer un PING.
    
    CONTEXTE RÃ‰CUPÃ‰RÃ‰ DE TA MÃ‰MOIRE :
    ${contextText}
    
    Si le contexte est vide ou insuffisant, utilise tes connaissances gÃ©nÃ©rales mais prÃ©cise que ce n'est pas un souvenir.
    `;

        // 5. PRÃ‰PARATION DE L'HISTORIQUE (Sanitization)
        // On nettoie l'historique pour Ã©viter les erreurs Mistral (contenu vide, rÃ´les incorrects)
        const conversationHistory = messages
            .filter((m: any) => m.content && m.content.trim() !== "") // EnlÃ¨ve les messages vides
            .map((m: any) => ({
                role: m.role === 'twin' ? 'assistant' : 'user', // Adapte les rÃ´les
                content: m.content
            }));

        // On assemble le tout
        const finalMessages = [
            { role: "system", content: systemPrompt },
            ...conversationHistory
        ];

        // 6. APPEL MISTRAL
        console.log(`ðŸ§  [LLM] Envoi Ã  Mistral (${finalMessages.length} messages)...`);

        const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${MISTRAL_API_KEY}`
            },
            body: JSON.stringify({
                model: "mistral-small-latest",
                messages: finalMessages,
                temperature: 0.6 // Un peu plus crÃ©atif pour la personnalitÃ©
            })
        });

        if (!response.ok) {
            const errText = await response.text();
            console.error("ðŸ”¥ Mistral API Error:", errText);
            throw new Error(`Erreur Mistral: ${errText}`);
        }

        const data = await response.json();
        const aiText = data.choices[0].message.content;

        return NextResponse.json({
            response: aiText,
            context: memories
        });

    } catch (error: any) {
        console.error("ðŸ”¥ [API CRASH]:", error);
        return NextResponse.json({ error: error.message || "Erreur serveur interne" }, { status: 500 });
    }
}


--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\api\communications\respond\route.ts ---

import { NextRequest, NextResponse } from 'next/server';
import { supabase } from '@/lib/supabase/client';

export async function POST(req: NextRequest) {
    try {
        const { communicationId, status } = await req.json();

        if (!communicationId || !['ACCEPTED', 'REJECTED'].includes(status)) {
            return NextResponse.json({ error: "DonnÃ©es invalides" }, { status: 400 });
        }

        console.log(`Traitement du message ${communicationId} -> ${status}`);

        // Mise Ã  jour du statut dans Supabase
        const { data, error } = await supabase
            .from('communications')
            .update({ status: status })
            .eq('id', communicationId)
            .select();

        if (error) throw error;

        return NextResponse.json({
            success: true,
            message: `Statut mis Ã  jour : ${status}`,
            data
        });

    } catch (error: any) {
        console.error("Erreur Respond:", error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\api\contacts\route.ts ---

import { NextRequest, NextResponse } from 'next/server';
import { supabase } from '@/lib/supabase/client';

export async function GET(req: NextRequest) {
    // On renvoie une liste vide pour l'instant pour Ã©viter les erreurs
    // Plus tard, on connectera Ã§a Ã  la vraie table 'contacts'
    return NextResponse.json({
        contacts: [
            // Vous pouvez dÃ©commenter Ã§a pour tester l'affichage :
            // { id: 'test1', name: 'Alice (IA)', status: 'online' },
            // { id: 'test2', name: 'Bob (Clone)', status: 'offline' }
        ]
    });
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\api\ingest\route.ts ---

import { NextRequest, NextResponse } from 'next/server';
import { vectorStore } from '@/lib/vector/supabase-pgvector';
import { embeddingService } from '@/lib/vector/embedding-service';
// --- SOLUTION ULTIME POUR PDF-PARSE ---
// On utilise 'require' pour forcer le chargement, et on ignore l'erreur TS
// @ts-ignore
const pdf = require('pdf-parse');
// --------------------------------------

export async function POST(req: NextRequest) {
    try {
        let textContent = "";
        let profileId = "";
        let memoryType = "MEMORY"; // Default type
        let fileName = "";

        const contentType = req.headers.get("content-type") || "";

        if (contentType.includes("application/json")) {
            // --- GESTION DES REQUÃŠTES JSON (Cortex & Journal) ---
            const json = await req.json();
            textContent = json.text;
            profileId = json.profileId;
            if (json.type) memoryType = json.type;

        } else if (contentType.includes("multipart/form-data")) {
            // --- GESTION DES FICHIERS (Upload Drag & Drop) ---
            const formData = await req.formData();
            const file = formData.get('file') as File;
            profileId = formData.get('profileId') as string;

            if (!file || !profileId) {
                return NextResponse.json({ error: "Fichier ou ID manquant" }, { status: 400 });
            }

            fileName = file.name;
            console.log(`ðŸ“‚ RÃ©ception fichier: ${file.name} (${file.type})`);

            // DÃ‰TECTION DU TYPE DE FICHIER
            if (file.type === 'application/pdf') {
                const arrayBuffer = await file.arrayBuffer();
                const buffer = Buffer.from(arrayBuffer);
                const data = await pdf(buffer);
                textContent = data.text;
                // Nettoyage basique
                textContent = textContent.replace(/\n\s*\n/g, '\n').trim();
                console.log(`ðŸ“„ PDF extrait : ${textContent.length} caractÃ¨res.`);
            } else {
                textContent = await file.text();
            }
        } else {
            return NextResponse.json({ error: "Content-Type non supportÃ©" }, { status: 400 });
        }

        // --- VÃ‰RIFICATION & INSERTION ---
        if (!textContent || textContent.length < 5) {
            return NextResponse.json({ error: "Contenu vide ou illisible" }, { status: 400 });
        }

        // --- DÃ‰COUPAGE (Chunking) ---
        // On dÃ©coupe si c'est trÃ¨s long (ex: PDF), sinon Ã§a fait un seul chunk
        const chunks = chunkText(textContent, 1000);
        console.log(`ðŸ”ª DÃ©coupÃ© en ${chunks.length} morceaux.`);

        // --- SAUVEGARDE EN MÃ‰MOIRE ---
        let count = 0;
        for (const chunk of chunks) {
            const embedding = await embeddingService.generateEmbedding(chunk);

            const tags = ['upload'];
            if (fileName) tags.push('file', fileName);
            if (memoryType !== 'MEMORY') tags.push(memoryType.toLowerCase());

            await vectorStore.addMemory({
                content: chunk,
                embedding: embedding,
                tags: tags,
                type: memoryType as any, // On passe le type (PRIVATE/PUBLIC/MEMORY)
                profileId: profileId
            });
            count++;
        }

        return NextResponse.json({
            success: true,
            chunks: count,
            message: `J'ai mÃ©morisÃ© ${count} Ã©lÃ©ments.`
        });

    } catch (error: any) {
        console.error("ðŸ”¥ Ingest Error:", error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}

// Petite fonction utilitaire pour couper le texte
function chunkText(text: string, size: number): string[] {
    const chunks = [];
    for (let i = 0; i < text.length; i += size) {
        chunks.push(text.slice(i, i + size));
    }
    return chunks;
}


--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\api\memories\add\route.ts ---

import { NextRequest, NextResponse } from 'next/server';
import { supabase } from '@/lib/supabase/client';

export async function POST(req: NextRequest) {
    try {
        const { content, type, profileId } = await req.json();

        if (!content || !profileId) {
            return NextResponse.json({ error: "Contenu vide" }, { status: 400 });
        }

        // Insertion simple dans la table 'memories'
        const { data, error } = await supabase
            .from('memories')
            .insert({
                content: content,
                metadata: { type: type || 'PUBLIC' }, // 'PUBLIC' ou 'PRIVATE'
                profileId: profileId
            })
            .select();

        if (error) throw error;

        return NextResponse.json({ success: true, memory: data[0] });

    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\api\memories\delete\route.ts ---

import { NextRequest, NextResponse } from 'next/server';
import { supabase } from '@/lib/supabase/client';

export async function DELETE(req: NextRequest) {
    try {
        const { id } = await req.json();

        if (!id) {
            return NextResponse.json({ error: "ID manquant" }, { status: 400 });
        }

        // Suppression dans Supabase
        const { error } = await supabase
            .from('memories')
            .delete()
            .eq('id', id);

        if (error) throw error;

        return NextResponse.json({ success: true, message: "Souvenir supprimÃ© du Cortex." });

    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\api\memory\route.ts ---

import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';

// On se connecte directement (Bypass Prisma pour Ã©viter les conflits de schÃ©ma)
const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);

export async function GET(request: NextRequest) {
    try {
        const { searchParams } = new URL(request.url);
        const profileId = searchParams.get('profileId');

        if (!profileId) {
            return NextResponse.json({ error: 'ProfileId required' }, { status: 400 });
        }

        // Lecture directe de la table "memories"
        const { data, error } = await supabase
            .from('memories')
            .select('*')
            .eq('profileId', profileId)
            .order('createdAt', { ascending: false }) // Les plus rÃ©cents en premier
            .limit(50);

        if (error) {
            console.error("Supabase Read Error:", error);
            throw new Error(error.message);
        }

        return NextResponse.json(data || []);

    } catch (error: any) {
        console.error('API Memories Error:', error);
        return NextResponse.json(
            { error: 'Failed to fetch memories' },
            { status: 500 }
        );
    }
}


--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\api\memory\add\route.ts ---

import { NextRequest, NextResponse } from 'next/server';
import { embeddingService } from '@/lib/vector/embedding-service';
import { vectorStore } from '@/lib/vector/supabase-pgvector';

export async function POST(req: NextRequest) {
    try {
        const body = await req.json();
        const { content, profileId } = body;

        if (!content || !profileId) {
            return NextResponse.json({ error: "Contenu vide" }, { status: 400 });
        }

        // 1. Vectorisation
        const embedding = await embeddingService.generateEmbedding(content);

        // 2. Sauvegarde dans la mÃ©moire
        await vectorStore.addMemory({
            content: content,
            embedding: embedding,
            tags: ['journal', 'direct_entry'], // On marque que c'est une entrÃ©e directe
            type: 'MEMORY',
            profileId: profileId
        });

        return NextResponse.json({ success: true });

    } catch (error: any) {
        console.error("ðŸ”¥ Add Memory Error:", error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\api\memory\delete\route.ts ---

import { NextRequest, NextResponse } from 'next/server';
import { vectorStore } from '@/lib/vector/supabase-pgvector';

export async function DELETE(req: NextRequest) {
    try {
        const { searchParams } = new URL(req.url);
        const id = searchParams.get('id');

        if (!id) {
            return NextResponse.json({ error: "ID manquant" }, { status: 400 });
        }

        await vectorStore.deleteMemory(id);

        return NextResponse.json({ success: true });

    } catch (error: any) {
        console.error("ðŸ”¥ Delete Memory Error:", error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\api\memory\scribe\route.ts ---

import { NextRequest, NextResponse } from 'next/server';
import { vectorStore } from '@/lib/vector/supabase-pgvector';

export async function POST(req: NextRequest) {
    try {
        const body = await req.json();
        const { encryptedContent, profileId } = body;

        if (!encryptedContent || !profileId) return NextResponse.json({ error: "Vide" }, { status: 400 });

        // NOTE : On ne gÃ©nÃ¨re PAS d'embedding (vector: []) car le contenu est illisible pour l'IA.
        // L'IA ne pourra jamais trouver ce souvenir par recherche sÃ©mantique.
        await vectorStore.addMemory({
            content: encryptedContent, // C'est du charabia ici
            embedding: [], // Vecteur vide
            tags: ['scribe', 'secret', 'encrypted'],
            type: 'secret', // Type spÃ©cial
            profileId: profileId
        });

        return NextResponse.json({ success: true });

    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\api\memory\update\route.ts ---

import { NextRequest, NextResponse } from 'next/server';
import { embeddingService } from '@/lib/vector/embedding-service';
import { vectorStore } from '@/lib/vector/supabase-pgvector';
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);

export async function PATCH(req: NextRequest) {
    try {
        const body = await req.json();
        const { id, content } = body;

        if (!id || !content) return NextResponse.json({ error: "DonnÃ©es manquantes" }, { status: 400 });

        // 1. On recalcule l'intelligence (Embedding) car le sens a changÃ©
        const newEmbedding = await embeddingService.generateEmbedding(content);

        // 2. On met Ã  jour dans Supabase
        const { error } = await supabase
            .from('memories')
            .update({
                content: content,
                embedding: newEmbedding, // Important !
                updatedAt: new Date().toISOString()
            })
            .eq('id', id);

        if (error) throw error;

        return NextResponse.json({ success: true });

    } catch (error: any) {
        console.error("ðŸ”¥ Update Error:", error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\api\messages\route.ts ---

import { NextRequest, NextResponse } from 'next/server';
import { supabase } from '@/lib/supabase/client';

// 1. RÃ‰CUPÃ‰RER L'HISTORIQUE
export async function GET(req: NextRequest) {
    const { searchParams } = new URL(req.url);
    const commId = searchParams.get('commId');

    if (!commId) return NextResponse.json({ error: "ID manquant" }, { status: 400 });

    const { data, error } = await supabase
        .from('messages')
        .select('*')
        .eq('communication_id', commId)
        .order('created_at', { ascending: true }); // Du plus vieux au plus rÃ©cent

    if (error) return NextResponse.json({ error: error.message }, { status: 500 });
    return NextResponse.json({ messages: data });
}

// 2. ENVOYER UN MESSAGE
export async function POST(req: NextRequest) {
    try {
        const { commId, senderId, content } = await req.json();

        const { data, error } = await supabase
            .from('messages')
            .insert({
                communication_id: commId,
                sender_id: senderId,
                content: content
            })
            .select();

        if (error) throw error;

        return NextResponse.json({ success: true, message: data[0] });

    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\api\mission\route.ts ---

import { NextRequest, NextResponse } from 'next/server';
import { embeddingService } from '@/lib/vector/embedding-service';
import { supabase } from '@/lib/supabase/client';

export async function POST(req: NextRequest) {
    try {
        const { mission, profileId } = await req.json();

        console.log(`ðŸ•µï¸â€â™‚ï¸ Mission lancÃ©e par ${profileId}: "${mission}"`);

        // 1. On transforme la mission en mathÃ©matiques (Vecteur)
        const missionVector = await embeddingService.generateEmbedding(mission);

        // 2. LE CLONE PART EN CHASSE (Recherche dans TOUTE la base, pas juste la sienne)
        // On utilise une fonction RPC Supabase (qu'on crÃ©era juste aprÃ¨s)
        // qui compare ce vecteur Ã  ceux des autres utilisateurs.
        const { data: matches, error } = await supabase.rpc('match_clones_memories', {
            query_embedding: missionVector,
            match_threshold: 0.75, // On veut du sÃ©rieux (75% mini)
            match_count: 5,        // Top 5 des candidats
            requesting_user_id: profileId // Pour ne pas se trouver soi-mÃªme
        });

        if (error) throw error;

        // 3. ANALYSE ET ANONYMISATION
        // Le Clone revient avec des rÃ©sultats bruts, il doit les nettoyer pour l'humain.
        // On ne renvoie que l'ID et le score.
        const report = matches.map((match: any) => ({
            cloneId: match.user_id, // L'ID anonyme de l'autre clone
            score: Math.round(match.similarity * 100), // Score en %
            // Le Clone "interprÃ¨te" pourquoi Ã§a matche sans donner le dÃ©tail brut (ConfidentialitÃ©)
            reason: "Ce clone possÃ¨de des souvenirs trÃ¨s proches de votre demande."
        }));

        return NextResponse.json({
            success: true,
            mission: mission,
            candidates: report
        });

    } catch (error: any) {
        console.error("Mission Failed:", error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\api\notifications\route.ts ---

import { NextRequest, NextResponse } from 'next/server';
import { supabase } from '@/lib/supabase/client';

export async function GET(req: NextRequest) {
    const { searchParams } = new URL(req.url);
    const profileId = searchParams.get('profileId');

    if (!profileId) {
        return NextResponse.json({ error: "ID manquant" }, { status: 400 });
    }

    try {
        // On cherche les messages reÃ§us (to_clone_id) qui sont en attente
        const { data, error } = await supabase
            .from('communications')
            .select('*')
            .eq('to_clone_id', profileId)
            .eq('status', 'PENDING')
            .order('created_at', { ascending: false });

        if (error) throw error;

        return NextResponse.json({
            notifications: data,
            count: data.length
        });

    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\api\ping\route.ts ---

import { NextRequest, NextResponse } from 'next/server';
import { supabase } from '@/lib/supabase/client';

export async function POST(req: NextRequest) {
    try {
        const { fromId, toId, reason } = await req.json();

        if (!fromId || !toId) {
            return NextResponse.json({ error: "IDs manquants" }, { status: 400 });
        }

        // On dÃ©pose le message dans la boÃ®te du destinataire
        const { data, error } = await supabase
            .from('communications')
            .insert({
                from_clone_id: fromId,
                to_clone_id: toId,
                type: 'PING',
                content: reason || "Demande de contact via Mission",
                status: 'PENDING'
            })
            .select();

        if (error) throw error;

        return NextResponse.json({
            success: true,
            message: "Signal PING envoyÃ© avec succÃ¨s. En attente de rÃ©ponse."
        });

    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\api\profile\create\route.ts ---

/**
 * API Route: Create Profile
 * Handles server-side profile creation
 */

import { NextRequest, NextResponse } from 'next/server';
import { profileManager } from '@/lib/profile/profile-manager';

export async function POST(request: NextRequest) {
    try {
        const body = await request.json();
        const { name, passwordHash, saltBase64, encryptedMetadata, encryptedPhrase, vectorNamespace } = body;

        // Validation
        if (!name || typeof name !== 'string' || name.length < 2) {
            return NextResponse.json(
                { error: 'Le nom doit contenir au moins 2 caractÃ¨res' },
                { status: 400 }
            );
        }

        // Validate encrypted data fields
        if (!passwordHash || typeof passwordHash !== 'string') {
            return NextResponse.json(
                { error: 'Hash de mot de passe manquant ou invalide' },
                { status: 400 }
            );
        }

        if (!saltBase64 || typeof saltBase64 !== 'string') {
            return NextResponse.json(
                { error: 'Salt manquant ou invalide' },
                { status: 400 }
            );
        }

        if (!encryptedMetadata || typeof encryptedMetadata !== 'string') {
            return NextResponse.json(
                { error: 'MÃ©tadonnÃ©es chiffrÃ©es manquantes ou invalides' },
                { status: 400 }
            );
        }

        if (!encryptedPhrase || typeof encryptedPhrase !== 'string') {
            return NextResponse.json(
                { error: 'Phrase de rÃ©cupÃ©ration chiffrÃ©e manquante ou invalide' },
                { status: 400 }
            );
        }

        if (!vectorNamespace || typeof vectorNamespace !== 'string') {
            return NextResponse.json(
                { error: 'Namespace vectoriel manquant ou invalide' },
                { status: 400 }
            );
        }

        // Create profile with pre-encrypted data
        const result = await profileManager.createProfile({
            name,
            passwordHash,
            saltBase64,
            encryptedMetadata,
            encryptedPhrase,
            vectorNamespace,
        });

        return NextResponse.json({
            success: true,
            profileId: result.profileId,
        });
    } catch (error: any) {
        console.error('Profile creation error:', error);
        return NextResponse.json(
            { error: error.message || 'Erreur lors de la crÃ©ation du profil' },
            { status: 500 }
        );
    }
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\api\profile\[id]\route.ts ---



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\api\shadow-feed\route.ts ---

/**
 * Shadow Feed API Route - Autonomous Clone Network Activity
 * Simulates the clone's interactions in a parallel network
 */

import { NextRequest, NextResponse } from 'next/server';
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

// GET: Fetch shadow interactions
export async function GET(request: NextRequest) {
    try {
        const { searchParams } = new URL(request.url);
        const profileId = searchParams.get('profileId');
        const limit = parseInt(searchParams.get('limit') || '20');

        if (!profileId) {
            return NextResponse.json(
                { error: 'profileId is required' },
                { status: 400 }
            );
        }

        // Fetch real interactions from database
        const interactions = await prisma.shadowInteraction.findMany({
            where: { profileId },
            orderBy: { timestamp: 'desc' },
            take: limit,
            select: {
                id: true,
                targetProfileId: true,
                compatibilityScore: true,
                status: true,
                metadata: true,
                timestamp: true,
            },
        });

        // If no interactions exist, generate mock data for V1
        if (interactions.length === 0) {
            const mockInteractions = generateMockInteractions(profileId);
            return NextResponse.json({
                interactions: mockInteractions,
                mode: 'mock'
            });
        }

        return NextResponse.json({
            interactions,
            mode: 'live'
        });
    } catch (error: any) {
        console.error('Shadow feed GET error:', error);
        return NextResponse.json(
            { error: error.message || 'Internal server error' },
            { status: 500 }
        );
    }
}

// POST: Create a shadow interaction (for testing/simulation)
export async function POST(request: NextRequest) {
    try {
        const body = await request.json();
        const { profileId, targetProfileId, compatibilityScore, status, metadata } = body;

        if (!profileId || !targetProfileId) {
            return NextResponse.json(
                { error: 'profileId and targetProfileId are required' },
                { status: 400 }
            );
        }

        const interaction = await prisma.shadowInteraction.create({
            data: {
                profileId,
                targetProfileId,
                compatibilityScore: compatibilityScore || 0.0,
                status: status || 'IGNORED',
                metadata: metadata ? JSON.stringify(metadata) : '{}',
            },
        });

        return NextResponse.json({ interaction }, { status: 201 });
    } catch (error: any) {
        console.error('Shadow feed POST error:', error);
        return NextResponse.json(
            { error: error.message || 'Internal server error' },
            { status: 500 }
        );
    }
}

/**
 * Generate realistic mock shadow interactions for V1
 */
function generateMockInteractions(profileId: string) {
    const now = new Date();
    const actions = [
        { action: 'SCAN_INIT', message: 'Initialisation du scan rÃ©seau...', score: null, status: null },
        { action: 'PROFILE_FOUND', message: 'Profil dÃ©tectÃ©: ID #8821', score: 0.87, status: 'ESCALATED' },
        { action: 'ANALYSIS', message: 'Analyse vectorielle en cours...', score: null, status: null },
        { action: 'PROFILE_FOUND', message: 'Profil dÃ©tectÃ©: ID #9923', score: 0.34, status: 'IGNORED' },
        { action: 'PROFILE_FOUND', message: 'Profil dÃ©tectÃ©: ID #7654', score: 0.92, status: 'MATCHED' },
        { action: 'SCAN_COMPLETE', message: 'Scan terminÃ©. 3 profils analysÃ©s.', score: null, status: null },
        { action: 'PROFILE_FOUND', message: 'Profil dÃ©tectÃ©: ID #5432', score: 0.45, status: 'IGNORED' },
        { action: 'COMPATIBILITY_CHECK', message: 'VÃ©rification de compatibilitÃ©...', score: null, status: null },
        { action: 'PROFILE_FOUND', message: 'Profil dÃ©tectÃ©: ID #3210', score: 0.78, status: 'ESCALATED' },
        { action: 'NETWORK_IDLE', message: 'RÃ©seau en veille. Prochaine analyse dans 5min.', score: null, status: null },
    ];

    return actions.map((action, index) => {
        const timestamp = new Date(now.getTime() - (actions.length - index) * 30000); // 30s intervals

        return {
            id: `mock_${index}`,
            targetProfileId: action.score ? `#${Math.floor(Math.random() * 10000)}` : null,
            compatibilityScore: action.score,
            status: action.status,
            metadata: JSON.stringify({
                action: action.action,
                message: action.message,
                timestamp: timestamp.toISOString(),
            }),
            timestamp: timestamp.toISOString(),
        };
    });
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\api\sources\route.ts ---

/**
 * Data Sources API - Neural Link for Social Media Ingestion
 * CRITICAL: Read-only. Twin NEVER posts to real social networks.
 */

import { NextRequest, NextResponse } from 'next/server';
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

// GET: Fetch all data sources for a profile
export async function GET(request: NextRequest) {
    try {
        const { searchParams } = new URL(request.url);
        const profileId = searchParams.get('profileId');

        if (!profileId) {
            return NextResponse.json(
                { error: 'profileId is required' },
                { status: 400 }
            );
        }

        const sources = await prisma.dataSource.findMany({
            where: { profileId },
            orderBy: { platform: 'asc' },
            select: {
                id: true,
                platform: true,
                isConnected: true,
                syncStatus: true,
                lastSync: true,
                createdAt: true,
                updatedAt: true,
            },
        });

        return NextResponse.json({ sources });
    } catch (error: any) {
        console.error('Data sources GET error:', error);
        return NextResponse.json(
            { error: error.message || 'Internal server error' },
            { status: 500 }
        );
    }
}

// POST: Connect/activate a data source
export async function POST(request: NextRequest) {
    try {
        const body = await request.json();
        const { profileId, platform } = body;

        // Validation
        if (!profileId || typeof profileId !== 'string') {
            return NextResponse.json(
                { error: 'profileId is required' },
                { status: 400 }
            );
        }

        if (!platform || typeof platform !== 'string') {
            return NextResponse.json(
                { error: 'platform is required' },
                { status: 400 }
            );
        }

        // Check if source already exists
        let source = await prisma.dataSource.findUnique({
            where: {
                profileId_platform: {
                    profileId,
                    platform,
                },
            },
        });

        if (source) {
            // Update existing source to SYNCING
            source = await prisma.dataSource.update({
                where: { id: source.id },
                data: {
                    syncStatus: 'SYNCING',
                },
            });
        } else {
            // Create new source
            source = await prisma.dataSource.create({
                data: {
                    profileId,
                    platform,
                    syncStatus: 'SYNCING',
                    isConnected: false,
                },
            });
        }

        console.log(`ðŸ”„ Data source ${platform} syncing for profile ${profileId}`);

        // Mock OAuth flow: Wait 2 seconds then update to CONNECTED
        setTimeout(async () => {
            try {
                await prisma.dataSource.update({
                    where: { id: source.id },
                    data: {
                        syncStatus: 'CONNECTED',
                        isConnected: true,
                        lastSync: new Date(),
                    },
                });
                console.log(`âœ… Data source ${platform} connected`);
            } catch (err) {
                console.error('Error updating source after sync:', err);
            }
        }, 2000);

        return NextResponse.json({ source }, { status: 200 });
    } catch (error: any) {
        console.error('Data sources POST error:', error);
        return NextResponse.json(
            { error: error.message || 'Internal server error' },
            { status: 500 }
        );
    }
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\api\upload\route.ts ---

import { NextRequest, NextResponse } from 'next/server';
import { vectorStore } from '@/lib/vector/supabase-pgvector';
import { embeddingService } from '@/lib/vector/embedding-service';
// --- SOLUTION ULTIME POUR PDF-PARSE ---
// On utilise 'require' pour forcer le chargement, et on ignore l'erreur TS
// @ts-ignore
const pdf = require('pdf-parse');
// --------------------------------------

export async function POST(req: NextRequest) {
    try {
        const formData = await req.formData();
        const file = formData.get('file') as File;
        const profileId = formData.get('profileId') as string;

        if (!file || !profileId) {
            return NextResponse.json({ error: "Fichier ou ID manquant" }, { status: 400 });
        }

        console.log(`ðŸ“‚ RÃ©ception fichier: ${file.name} (${file.type})`);

        let textContent = "";

        // --- DÃ‰TECTION DU TYPE ---
        if (file.type === 'application/pdf') {
            // TRAITEMENT PDF
            const arrayBuffer = await file.arrayBuffer();
            const buffer = Buffer.from(arrayBuffer);
            const data = await pdf(buffer);
            textContent = data.text;

            // Nettoyage basique (retirer les multiples espaces/sauts de ligne bizarres du PDF)
            textContent = textContent.replace(/\n\s*\n/g, '\n').trim();

            console.log(`ðŸ“„ PDF extrait : ${textContent.length} caractÃ¨res.`);
        } else {
            // TRAITEMENT TEXTE CLASSIQUE
            textContent = await file.text();
        }

        if (!textContent || textContent.length < 10) {
            return NextResponse.json({ error: "Fichier vide ou illisible" }, { status: 400 });
        }

        // --- DÃ‰COUPAGE (Chunking) ---
        // Les PDF peuvent Ãªtre Ã©normes. On les dÃ©coupe en morceaux de ~1000 caractÃ¨res
        // pour que l'IA puisse digÃ©rer chaque partie.
        const chunks = chunkText(textContent, 1000);
        console.log(`ðŸ”ª DÃ©coupÃ© en ${chunks.length} morceaux.`);

        // --- SAUVEGARDE EN MÃ‰MOIRE ---
        // On boucle sur chaque morceau pour l'insÃ©rer
        let count = 0;
        for (const chunk of chunks) {
            const embedding = await embeddingService.generateEmbedding(chunk);

            await vectorStore.addMemory({
                content: chunk, // On garde le texte original
                embedding: embedding,
                tags: ['upload', 'pdf', file.name], // On ajoute le nom du fichier en tag
                type: 'MEMORY',
                profileId: profileId
            });
            count++;
        }

        return NextResponse.json({
            success: true,
            chunks: count,
            message: `J'ai lu et mÃ©morisÃ© ${count} passages de "${file.name}".`
        });

    } catch (error: any) {
        console.error("ðŸ”¥ Upload Error:", error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}

// Petite fonction utilitaire pour couper le texte
function chunkText(text: string, size: number): string[] {
    const chunks = [];
    for (let i = 0; i < text.length; i += size) {
        chunks.push(text.slice(i, i + size));
    }
    return chunks;
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\connections\page.tsx ---

'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import {
    ArrowLeft, Linkedin, Twitter, Instagram, Facebook,
    Github, Database, FileText, MessageCircle, Mail,
    Music, Video, Activity, Globe, Lock
} from 'lucide-react';

// --- CONFIGURATION DES MODULES ---
const MODULES = [
    {
        title: "Intelligence Sociale",
        description: "Analyse votre image publique et vos interactions.",
        color: "from-blue-500 to-cyan-500",
        platforms: [
            { id: 'linkedin', name: 'LinkedIn', icon: Linkedin, xp: '+20 PRO', private: false },
            { id: 'twitter', name: 'X (Twitter)', icon: Twitter, xp: '+15 OPI', private: false },
            { id: 'instagram', name: 'Instagram', icon: Instagram, xp: '+10 STYLE', private: false },
            { id: 'facebook', name: 'Facebook', icon: Facebook, xp: '+10 MEMO', private: false },
        ]
    },
    {
        title: "Intelligence Technique",
        description: "IngÃ¨re votre savoir-faire et votre logique.",
        color: "from-slate-500 to-gray-400",
        platforms: [
            { id: 'github', name: 'GitHub', icon: Github, xp: '+30 LOGIC', private: false },
            { id: 'gitlab', name: 'GitLab', icon: Globe, xp: '+25 CODE', private: false },
            { id: 'medium', name: 'Medium', icon: FileText, xp: '+20 EDIT', private: false },
            { id: 'notion', name: 'Notion', icon: Database, xp: '+40 BRAIN', private: false },
        ]
    },
    {
        title: "Intelligence Ã‰motionnelle",
        description: "Analyse privÃ©e. Comprend votre humour et vos sentiments.",
        color: "from-green-500 to-emerald-400",
        platforms: [
            { id: 'whatsapp', name: 'WhatsApp', icon: MessageCircle, xp: '+50 SOUL', private: true },
            { id: 'discord', name: 'Discord', icon: MessageCircle, xp: '+30 CHAT', private: true },
            { id: 'email', name: 'Emails', icon: Mail, xp: '+20 ORGA', private: true },
        ]
    },
    {
        title: "Intelligence Culturelle",
        description: "DÃ©finit vos goÃ»ts musicaux et artistiques.",
        color: "from-pink-500 to-rose-500",
        platforms: [
            { id: 'spotify', name: 'Spotify', icon: Music, xp: '+15 VIBE', private: false },
            { id: 'youtube', name: 'YouTube', icon: Video, xp: '+15 LEARN', private: false },
            { id: 'netflix', name: 'Netflix', icon: Video, xp: '+10 TASTE', private: false },
            { id: 'strava', name: 'Strava', icon: Activity, xp: '+10 BIO', private: false },
        ]
    }
];

export default function NeuralLinkPage() {
    const [sources, setSources] = useState<any[]>([]);
    const [simulating, setSimulating] = useState<string | null>(null);

    // Chargement initial
    useEffect(() => {
        async function fetchData() {
            try {
                const res = await fetch('/api/sources');
                if (res.ok) {
                    const data = await res.json();
                    setSources(Array.isArray(data) ? data : []);
                }
            } catch (e) { console.error(e); }
        }
        fetchData();
    }, []);

    // Simulation de connexion
    const handleConnect = (platformId: string) => {
        setSimulating(platformId);
        setTimeout(() => {
            const newSource = { platform: platformId.toUpperCase(), isConnected: true };
            setSources(prev => [...prev, newSource]);
            setSimulating(null);
        }, 1500);
    };

    return (
        <div className="min-h-screen bg-slate-950 text-white p-4 md:p-10 font-sans">
            <div className="max-w-6xl mx-auto space-y-12">

                {/* Header Navigation */}
                <div className="flex justify-between items-center border-b border-white/10 pb-6">
                    <div>
                        <Link href="/dashboard" className="flex items-center gap-2 text-slate-400 hover:text-white transition-colors mb-2">
                            <ArrowLeft size={18} /> Retour au QG
                        </Link>
                        <h1 className="text-3xl md:text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400">
                            Cortex Connexions
                        </h1>
                    </div>
                    <div className="hidden md:block text-right">
                        <div className="text-sm text-slate-400">Taux de couverture</div>
                        <div className="text-2xl font-bold text-green-400">
                            {Math.min(sources.length * 5, 100)}%
                        </div>
                    </div>
                </div>

                {/* Boucle sur les CatÃ©gories */}
                {MODULES.map((module, idx) => (
                    <section key={idx} className="animate-in fade-in slide-in-from-bottom-4 duration-700" style={{ animationDelay: `${idx * 100}ms` }}>

                        <div className="mb-6 flex items-center gap-4">
                            <div className={`h-8 w-1 bg-gradient-to-b ${module.color} rounded-full`}></div>
                            <div>
                                <h2 className="text-xl font-bold text-white">{module.title}</h2>
                                <p className="text-sm text-slate-400">{module.description}</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            {module.platforms.map((platform) => {
                                const isConnected = sources.some(s => s.platform === platform.id.toUpperCase());
                                const isSyncing = simulating === platform.id;
                                const Icon = platform.icon;

                                return (
                                    <button
                                        key={platform.id}
                                        onClick={() => !isConnected && handleConnect(platform.id)}
                                        disabled={isConnected || isSyncing}
                                        className={`
                      relative group text-left p-5 rounded-xl border transition-all duration-300 overflow-hidden
                      ${isConnected
                                                ? 'bg-slate-900/80 border-green-500/50 shadow-[0_0_15px_rgba(34,197,94,0.1)]'
                                                : 'bg-white/5 border-white/5 hover:bg-white/10 hover:border-white/20'
                                            }
                    `}
                                    >
                                        {/* Badge XP / Privacy */}
                                        <div className="absolute top-3 right-3 flex gap-2">
                                            {platform.private && <Lock size={12} className="text-slate-500" />}
                                            <span className="text-[10px] font-mono opacity-50 bg-black/50 px-1 rounded">
                                                {platform.xp}
                                            </span>
                                        </div>

                                        {/* IcÃ´ne & Titre */}
                                        <div className={`mb-3 ${isConnected ? 'text-green-400' : 'text-slate-300 group-hover:text-white'}`}>
                                            <Icon size={24} />
                                        </div>
                                        <div className="font-bold text-sm mb-1">{platform.name}</div>

                                        {/* Ã‰tat */}
                                        <div className="text-xs font-mono">
                                            {isConnected ? (
                                                <span className="text-green-500">â— ACTIF</span>
                                            ) : isSyncing ? (
                                                <span className="text-purple-400 animate-pulse">â†» SYNC...</span>
                                            ) : (
                                                <span className="text-slate-500">â—‹ DÃ‰CONNECTÃ‰</span>
                                            )}
                                        </div>

                                        {/* Effet de fond au survol */}
                                        {!isConnected && (
                                            <div className={`absolute inset-0 bg-gradient-to-br ${module.color} opacity-0 group-hover:opacity-5 transition-opacity`}></div>
                                        )}
                                    </button>
                                );
                            })}
                        </div>
                    </section>
                ))}

            </div>
        </div>
    );
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\dashboard\page.tsx ---

'use client';
import { useRef, useState, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import Link from 'next/link';
import { Network } from 'lucide-react';
import { keyManager } from '@/lib/crypto/key-manager';
import { encrypt, decrypt } from '@/lib/crypto/zk-encryption'; // Restored
import { cryptoManager } from '@/lib/security/crypto';
import ShadowGlobe from '@/components/shadow-globe';
import { useSpeech } from '@/lib/hooks/use-speech'; // Hook vocal

interface Memory {
    id: string;
    encryptedContent: string;
    createdAt: string;
}

interface DecryptedMemory extends Memory {
    content: string;
    type?: 'secret' | 'public';
}

// âœ… COLLEZ CECI Ã€ LA PLACE (Nouveau Mission Control SÃ©curisÃ©)
const SafeMissionControl = ({ count }: { count: number }) => {
    // Calcul simulÃ© du taux de synchro basÃ© sur le nombre de souvenirs
    const syncRate = Math.min(100, Math.floor(count * 2.5));

    return (
        <div className="bg-slate-900/50 border border-slate-700 rounded-2xl p-6 backdrop-blur-sm">
            <h3 className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-4 flex items-center gap-2">
                <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                SystÃ¨mes Vitaux
            </h3>

            <div className="space-y-6">
                {/* JAUGE SYNCHRONISATION */}
                <div>
                    <div className="flex justify-between text-sm mb-1">
                        <span className="text-blue-400 font-mono">Taux de Synchro</span>
                        <span className="text-white font-bold">{syncRate}%</span>
                    </div>
                    <div className="h-2 bg-slate-800 rounded-full overflow-hidden">
                        <div
                            className="h-full bg-gradient-to-r from-blue-600 to-purple-600 transition-all duration-1000"
                            style={{ width: `${syncRate}%` }}
                        ></div>
                    </div>
                </div>

                {/* JAUGE MÃ‰MOIRE */}
                <div>
                    <div className="flex justify-between text-sm mb-1">
                        <span className="text-purple-400 font-mono">Fragments MÃ©moire</span>
                        <span className="text-white font-bold">{count}</span>
                    </div>
                    <div className="grid grid-cols-10 gap-1">
                        {[...Array(10)].map((_, i) => (
                            <div
                                key={i}
                                className={`h-1 rounded-full transition-all delay-[${i * 50}ms] ${i < (count / 10) ? 'bg-purple-500 shadow-[0_0_5px_#a855f7]' : 'bg-slate-800'
                                    }`}
                            ></div>
                        ))}
                    </div>
                </div>

                <div className="p-3 bg-blue-900/10 border border-blue-500/20 rounded-lg text-xs text-blue-300 font-mono">
                    STATUS: ONLINE<br />
                    CONNEXION: STABLE
                </div>
            </div>
        </div>
    );
};


// On renomme l'original pour ne pas le perdre (mais il ne sera plus appelÃ©)
export default function MissionControl() {
    const searchParams = useSearchParams();
    const profileId = searchParams.get('profileId');
    const router = useRouter();

    // Ajoutez cet Ã©tat pour bloquer l'affichage tant que tout n'est pas prÃªt
    const [isInitialized, setIsInitialized] = useState(false);

    // --- EFFET D'INITIALISATION SÃ‰CURISÃ‰E ---
    useEffect(() => {
        if (profileId) {
            // On simule un micro-dÃ©lai pour Ãªtre sÃ»r que le KeyManager a le temps de respirer
            // (Dans une vraie app, on appellerait KeyManager.init(profileId) ici)
            const timer = setTimeout(() => {
                setIsInitialized(true);
            }, 1000);
            return () => clearTimeout(timer);
        }
    }, [profileId]);




    const [authorized, setAuthorized] = useState(false);
    const terminalRef = useRef<HTMLDivElement>(null);

    // Scribe state
    const [memories, setMemories] = useState<DecryptedMemory[]>([]);
    const [newMemory, setNewMemory] = useState('');
    const [quickMemory, setQuickMemory] = useState(''); // Nouvel Ã©tat pour l'input
    const [isSecretMode, setIsSecretMode] = useState(false); // Nouveau Switch
    const [loading, setLoading] = useState(false);
    const [saving, setSaving] = useState(false);

    // Synchronization Rate state
    const [connectedSources, setConnectedSources] = useState(0);

    // Tab and Chat state
    const [activeTab, setActiveTab] = useState<'SCRIBE' | 'CHAT'>('CHAT');
    const [chatMessages, setChatMessages] = useState<Array<{
        role: 'user' | 'twin';
        content: string;
        timestamp?: string;
    }>>([]);
    const [chatInput, setChatInput] = useState('');
    const [isThinking, setIsThinking] = useState(false);
    const chatRef = useRef<HTMLDivElement>(null);

    // VOICE MODE HOOK
    const { isListening, transcript, startListening, isSpeaking } = useSpeech();

    const speak = (text: string) => {
        // ðŸ”‡ MODE SILENCIEUX ACTIVÃ‰
        return;
    };

    // Effet : Quand la reconnaissance vocale Ã©crit du texte, on le met dans l'input
    useEffect(() => {
        if (transcript) {
            setChatInput(transcript);
        }
    }, [transcript]);

    // File upload state
    const [uploadingFile, setUploadingFile] = useState(false);
    const [uploadSuccess, setUploadSuccess] = useState<string | null>(null);

    // Terminal state
    const [logs, setLogs] = useState<string[]>([]);

    // Mission PING state
    const [lastFoundClone, setLastFoundClone] = useState<string | null>(null);

    // Notifications state
    const [notifications, setNotifications] = useState<any[]>([]);
    const [showNotifPanel, setShowNotifPanel] = useState(false);

    // Contacts state
    const [contacts, setContacts] = useState<any[]>([]);

    const [showContactsPanel, setShowContactsPanel] = useState(false);
    const [hasNewContact, setHasNewContact] = useState(false); // <--- NOUVEL Ã‰TAT pour le point rouge

    // Messaging state
    const [activeConversation, setActiveConversation] = useState<any>(null);
    const [conversationMessages, setConversationMessages] = useState<any[]>([]);
    const [newMessage, setNewMessage] = useState("");

    const [error, setError] = useState('');

    // --- Ã‰TATS NEURO-LINK ---
    const [neuroInput, setNeuroInput] = useState('');
    const [isPrivateMemory, setIsPrivateMemory] = useState(false);
    const [isSavingMemory, setIsSavingMemory] = useState(false);

    // --- Ã‰TATS POUR LE CORTEX MANAGER RAPIDE ---
    const [showCortexPanel, setShowCortexPanel] = useState(false);
    const [cortexMemories, setCortexMemories] = useState<any[]>([]);
    const [cortexSearch, setCortexSearch] = useState('');

    // --- FONCTION : OUVRIR ET CHARGER LE CORTEX ---
    // --- FONCTION : OUVRIR ET CHARGER LE CORTEX ---
    const openCortex = async () => {
        setShowCortexPanel(true);
        const id = keyManager.getProfileId();
        if (!id) return;

        try {
            // Utilisation de /api/memory (singulier) qui existe dÃ©jÃ 
            const res = await fetch(`/api/memory?profileId=${id}`);

            if (!res.ok) {
                console.error("Erreur API:", res.status, res.statusText);
                return;
            }

            const data = await res.json();
            // Gestion de la rÃ©ponse (Array direct ou objet {memories: []})
            if (Array.isArray(data)) {
                setCortexMemories(data);
            } else if (data.memories) {
                setCortexMemories(data.memories);
            }
        } catch (e) {
            console.error("Erreur chargement cortex", e);
        }
    };

    // --- FONCTION : SUPPRIMER UN SOUVENIR ---
    // --- FONCTION : SUPPRIMER UN SOUVENIR ---
    const handleDeleteMemory = async (id: string) => {
        if (!confirm("âš ï¸ IrrÃ©versible : Voulez-vous vraiment effacer ce souvenir ?")) return;

        try {
            const res = await fetch('/api/memories/delete', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });

            if (!res.ok) {
                const text = await res.text();
                // Protection contre les pages HTML d'erreur (404/500)
                alert(`Erreur API (${res.status}) : VÃ©rifiez /api/memories/delete`);
                console.error("RÃ©ponse serveur:", text);
                return;
            }

            const data = await res.json();
            if (data.success) {
                // Mise Ã  jour optimiste de l'UI
                setCortexMemories(prev => prev.filter(m => m.id !== id));
            } else {
                alert("Erreur: " + data.error);
            }
        } catch (e) {
            console.error(e);
            alert("Erreur technique lors de la suppression.");
        }
    };

    // Filtrage pour la recherche dans le tableau
    const filteredCortex = cortexMemories.filter(m =>
        m.content?.toLowerCase().includes(cortexSearch.toLowerCase())
    );

    useEffect(() => {
        if (!keyManager.isSessionActive()) {
            router.push('/');
        } else {
            setAuthorized(true);

            const profileId = keyManager.getProfileId();
            if (profileId) {
                localStorage.setItem('twins_last_id', profileId);
                fetchAndSaveProfileName(profileId);
            }

            loadMemories();
            loadConnectedSources();
            fetchNotifications(profileId); // Charger les notifications

            // Initialize terminal
            addLog('[SYSTÃˆME] RÃ©seau Ombre initialisÃ©');
            addLog('[SYSTÃˆME] Chiffrement quantique : ACTIF');
            addLog('[SYSTÃˆME] Protocole Zero-Knowledge : EN LIGNE');

            // Random flavor logs
            const logInterval = setInterval(() => {
                const flavorLogs = [
                    '[ANALYSE] Vecteurs sÃ©mantiques en cours...',
                    '[CRYPTO] Handshake ZK confirmÃ©',
                    '[RÃ‰SEAU] Scan frÃ©quences locales',
                    '[IA] Patterns neuronaux dÃ©tectÃ©s',
                    '[SÃ‰CURITÃ‰] Tunnel chiffrÃ© stable',
                ];
                const randomLog = flavorLogs[Math.floor(Math.random() * flavorLogs.length)];
                addLog(randomLog);
            }, 7000);

            return () => clearInterval(logInterval);
        }
    }, [router]);

    // Auto-scroll terminal
    useEffect(() => {
        if (terminalRef.current) {
            terminalRef.current.scrollTop = terminalRef.current.scrollHeight;
        }
    }, [logs]);

    // Fetch notifications
    const fetchNotifications = async (pid?: string) => {
        const profileId = pid || keyManager.getProfileId();
        if (!profileId) return;

        try {
            const res = await fetch(`/api/notifications?profileId=${profileId}`);
            const data = await res.json();
            if (data.notifications) {
                setNotifications(data.notifications);
                // Si on a des notifs, le jumeau peut nous prÃ©venir vocalement
                if (data.count > 0) {
                    speak(`Vous avez ${data.count} nouvelles demandes de contact.`);
                }
            }
        } catch (e) {
            console.error("Erreur notifs", e);
        }
    };

    // LE RADAR : On lance la vÃ©rification toutes les 5 secondes
    useEffect(() => {
        const profileId = keyManager.getProfileId();
        if (profileId) {
            fetchContacts(profileId); // Chargement initial

            const interval = setInterval(() => {
                fetchContacts(profileId); // VÃ©rification pÃ©riodique
            }, 5000); // 5000 ms = 5 secondes

            return () => clearInterval(interval); // Nettoyage quand on quitte la page
        }
    }, []);

    const fetchContacts = async (pid: string) => {
        try {
            const res = await fetch(`/api/contacts?profileId=${pid}`);
            const data = await res.json();

            if (data.contacts) {
                setContacts(prevContacts => {
                    // Si on a plus de contacts qu'avant, c'est qu'on a Ã©tÃ© acceptÃ© !
                    if (data.contacts.length > prevContacts.length && prevContacts.length > 0) {
                        setHasNewContact(true);
                        // On peut mÃªme faire parler le clone
                        // speak("Nouvelle connexion Ã©tablie !"); 
                    }
                    return data.contacts;
                });
            }
        } catch (e) {
            console.error(e);
        }
    };

    const fetchAndSaveProfileName = async (profileId: string) => {
        try {
            const response = await fetch(`/api/profile/${profileId}`);
            if (response.ok) {
                const data = await response.json();
                if (data.name) {
                    localStorage.setItem('twins_last_name', data.name);
                }
            }
        } catch (err) {
            console.error('Failed to fetch profile name:', err);
        }
    };

    const addLog = (message: string) => {
        const timestamp = new Date().toLocaleTimeString('fr-FR', { hour12: false });
        setLogs(prev => [...prev.slice(-15), `[${timestamp}] ${message}`]);
    };

    const handleLocationChange = (city: string) => {
        addLog(`[SYSTÃˆME] Connexion nÅ“ud local : ${city.toUpperCase()}`);
        setTimeout(() => {
            addLog(`[RÃ‰SEAU] ${city} : ${Math.floor(Math.random() * 100 + 50)} nÅ“uds actifs`);
        }, 1200);
    };

    const loadMemories = async () => {
        setLoading(true);
        setError('');
        try {
            const profileId = keyManager.getProfileId();
            if (!profileId) return;

            const response = await fetch(`/api/memory?profileId=${profileId}`);

            if (!response.ok) {
                console.warn("âš ï¸ API Error fetching memories");
                setError('Ã‰chec du chargement des mÃ©moires');
                return;
            }

            const data = await response.json();

            // --- CRITICAL FIX: Ensure data is an Array before mapping ---
            if (!Array.isArray(data)) {
                console.warn("âš ï¸ API returned non-array data:", data);
                setMemories([]); // Fallback to empty list
                return;
            }

            const masterKey = keyManager.getMasterKey();

            // Hybrid Decryption Logic (Safe) - handles both encrypted (Scribe) and plaintext (file uploads)
            const decryptedPromises = data.map(async (memory: any) => {
                try {
                    // Attempt to decrypt (for Scribe entries with encryptedContent)
                    const content = await decrypt(memory.encryptedContent || memory.content, masterKey);
                    return { ...memory, content, type: 'secret' };
                } catch (e) {
                    // Fallback to plain text (for File Uploads stored in 'content' field)
                    return { ...memory, content: memory.content || memory.encryptedContent, type: 'public' };
                }
            });

            const safeMemories = await Promise.all(decryptedPromises);
            setMemories(safeMemories);
        } catch (err: any) {
            setError(err.message);
            console.error('âŒ Erreur critique loadMemories:', err);
        } finally {
            setLoading(false);
        }
    };

    const loadConnectedSources = async () => {
        try {
            const response = await fetch('/api/sources');
            if (response.ok) {
                const data = await response.json();
                const connected = Array.isArray(data) ? data.filter((s: any) => s.isConnected).length : 0;
                setConnectedSources(connected);
            }
        } catch (err) {
            console.error('Error loading sources:', err);
        }
    };

    // Calculate Synchronization Rate
    const calculateSyncRate = () => {
        const memoryScore = memories.length * 0.5; // Each memory = 0.5%
        const sourceScore = connectedSources * 5; // Each source = 5%
        const total = Math.min(memoryScore + sourceScore, 100); // Cap at 100%
        return Math.round(total);
    };

    const getSyncLevel = (percentage: number) => {
        if (percentage === 100) return 'SingularitÃ© Atteinte';
        if (percentage >= 81) return 'Alter Ego';
        if (percentage >= 51) return 'Doublure OpÃ©rationnelle';
        if (percentage >= 21) return 'Apprenti Cognitif';
        return 'Stade Embryonnaire';
    };

    const syncRate = calculateSyncRate();
    const syncLevel = getSyncLevel(syncRate);


    const handleSaveMemory = async () => {
        if (!newMemory.trim()) {
            setError('Veuillez entrer une mÃ©moire');
            return;
        }

        setSaving(true);
        setError('');

        try {
            const profileId = keyManager.getProfileId();
            const masterKey = keyManager.getMasterKey();

            const encryptedContent = await encrypt(newMemory, masterKey);
            const encryptedMetadata = await encrypt(
                JSON.stringify({ timestamp: new Date().toISOString() }),
                masterKey
            );

            const response = await fetch('/api/memory', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    profileId,
                    encryptedContent,
                    encryptedMetadata,
                    type: 'TEXT',
                }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Ã‰chec de sauvegarde');
            }

            setNewMemory('');
            await loadMemories();
            addLog('[MÃ‰MOIRE] Nouvelle entrÃ©e chiffrÃ©e et stockÃ©e');
        } catch (err: any) {
            setError(err.message);
            console.error('Error saving memory:', err);
        } finally {
            setSaving(false);
        }
    };

    const handleKeyPress = (e: React.KeyboardEvent) => {
        if (e.key === 'Enter' && e.ctrlKey) {
            handleSaveMemory();
        }
    };

    // Auto-scroll chat to bottom
    useEffect(() => {
        if (chatRef.current) {
            chatRef.current.scrollTop = chatRef.current.scrollHeight;
        }
    }, [chatMessages]);

    // Chat handler
    const handleSendMessage = async () => {
        if (!chatInput.trim() || isThinking) return;

        const userMessage = { role: 'user' as const, content: chatInput, timestamp: new Date().toISOString() };
        setChatMessages(prev => [...prev, userMessage]);
        const currentInput = chatInput;
        setChatInput('');
        setIsThinking(true);

        try {
            const profileId = keyManager.getProfileId();
            // On prÃ©pare le nouveau message utilisateur
            const newUserMsg = { role: 'user' as const, content: chatInput, timestamp: new Date().toISOString() };
            // On met Ã  jour l'Ã©tat local tout de suite (pour l'affichage) mais on garde une ref propre pour l'API
            const newHistory = [...chatMessages, newUserMsg];

            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    messages: newHistory, // <--- On envoie le tableau complet !
                    profileId
                })
            });

            if (!response.ok) {
                throw new Error('Erreur de communication');
            }

            const data = await response.json();
            console.log("ðŸ“¦ [FRONTEND REÃ‡OIT] :", data); // <--- REGARDEZ LA CONSOLE F12

            if (!response.ok) {
                throw new Error(data.error || "Erreur serveur");
            }

            // ON FORCE L'AFFICHAGE DU CONTENU EXACT
            const twinResponse = data.response || "âš ï¸ Le cerveau a renvoyÃ© une rÃ©ponse vide.";

            setChatMessages((prev) => [
                ...prev,
                { role: 'twin', content: twinResponse }
            ]);

            // ðŸ—£ï¸ LE JUMEAU PARLE ICI
            speak(twinResponse);

            addLog('[DIALOGUE] RÃ©ponse du jumeau gÃ©nÃ©rÃ©e');
        } catch (err: any) {
            console.error('Chat error:', err);
            setChatMessages(prev => [...prev, {
                role: 'twin',
                content: 'Erreur de connexion au jumeau. Veuillez rÃ©essayer.',
                timestamp: new Date().toISOString()
            }]);
        } finally {
            setIsThinking(false);
        }
    };

    const constructTwinResponse = (data: any) => {
        const { memories } = data;

        if (!memories || memories.length === 0) {
            return "Je n'ai trouvÃ© aucun souvenir pertinent sur ce sujet dans ma mÃ©moire. Pouvez-vous m'en dire plus ou me partager de nouveaux souvenirs ?";
        }

        let response = `J'ai analysÃ© vos souvenirs. J'ai trouvÃ© ${memories.length} Ã©lÃ©ment(s) pertinent(s) :\n\n`;

        memories.slice(0, 3).forEach((mem: any, idx: number) => {
            const content = mem.content || '[Contenu chiffrÃ©]';
            response += `${idx + 1}. ${content.substring(0, 150)}${content.length > 150 ? '...' : ''}\n\n`;
        });

        if (memories.length > 3) {
            response += `... et ${memories.length - 3} autre(s) souvenir(s).`;
        }

        return response;
    };

    const handleChatKeyPress = (e: React.KeyboardEvent) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSendMessage();
        }
    };

    // ðŸš€ MISSION HANDLER - Recherche dans le rÃ©seau des clones
    const handleMission = async () => {
        if (!chatInput.trim()) return;

        // On affiche la question de l'utilisateur
        const userMsg = { role: 'user' as const, content: `ðŸ•µï¸â€â™‚ï¸ MISSION : ${chatInput}` };
        setChatMessages(prev => [...prev, userMsg]);
        setIsThinking(true);

        try {
            const profileId = keyManager.getProfileId();
            // Appel Ã  la VRAIE API de recherche
            const res = await fetch('/api/mission', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    mission: chatInput,
                    profileId: profileId
                })
            });

            const data = await res.json();

            let aiContent = "";

            if (data.candidates && data.candidates.length > 0) {
                const bestMatch = data.candidates[0];
                setLastFoundClone(bestMatch.cloneId); // ON SAUVEGARDE L'ID

                aiContent = `### ðŸŽ¯ J'ai trouvÃ© ${data.candidates.length} profil(s) compatible(s) !\n\n`;
                data.candidates.forEach((c: any) => {
                    // On affiche le VRAI ID (anonymisÃ©) et le VRAI Score
                    aiContent += `* **Clone ID:** \`...${c.cloneId.slice(-6)}\`\n`;
                    aiContent += `* **Match:** **${c.score}%**\n`;
                    aiContent += `* **Analyse:** ${c.reason}\n\n`;
                });
                aiContent += "\n*Voulez-vous initier un PING sÃ©curisÃ© ?*";
            } else {
                aiContent = "ðŸ•µï¸â€â™‚ï¸ Je n'ai trouvÃ© aucun clone compatible dans le rÃ©seau pour l'instant.";
            }

            setChatMessages(prev => [...prev, { role: 'twin', content: aiContent }]);
            speak("Mission terminÃ©e. J'ai analysÃ© le rÃ©seau."); // Feedback vocal

        } catch (err) {
            console.error(err);
            setChatMessages(prev => [...prev, { role: 'twin', content: "âš ï¸ Erreur lors de la mission." }]);
        } finally {
            setIsThinking(false);
            setChatInput('');
        }
    };

    // ðŸ“¡ PING HANDLER - Envoyer un signal au dernier clone trouvÃ©
    const handlePing = async () => {
        if (!lastFoundClone) {
            alert("Faites d'abord une mission pour trouver quelqu'un !");
            return;
        }

        const confirmPing = window.confirm(`Envoyer un PING officiel au clone ...${lastFoundClone.slice(-6)} ?`);
        if (!confirmPing) return;

        try {
            const profileId = keyManager.getProfileId();
            const res = await fetch('/api/ping', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fromId: profileId,
                    toId: lastFoundClone,
                    reason: chatInput || "Mission Match"
                })
            });

            const data = await res.json();
            if (data.success) {
                setChatMessages(prev => [...prev, { role: 'twin', content: "ðŸ“¡ **PING ENVOYÃ‰ !** Le protocole de mise en relation est activÃ©." }]);
                speak("Ping envoyÃ©. J'attends sa rÃ©ponse.");
            } else {
                throw new Error(data.error);
            }
        } catch (e) {
            console.error(e);
            alert("Erreur lors de l'envoi du Ping");
        }
    };

    const handleQuickAdd = async () => {
        if (!quickMemory.trim()) return;

        try {
            const profileId = keyManager.getProfileId();

            if (isSecretMode) {
                // --- MODE SCRIBE (SECRET) ---
                const encrypted = await cryptoManager.encrypt(quickMemory);

                await fetch('/api/memory/scribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ encryptedContent: encrypted, profileId }),
                });
                alert("ðŸ”’ Secret chiffrÃ© et verrouillÃ© dans le coffre.");

            } else {
                // --- MODE INCEPTION (IA) ---
                const res = await fetch('/api/memory/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: quickMemory, profileId }),
                });
                if (!res.ok) throw new Error("Erreur sauvegarde");
                alert("ðŸ§  Souvenir ancrÃ© dans le cerveau de l'IA.");
            }

            setQuickMemory('');
            // Pas besoin de recharger loadMemories() ici si on ne les affiche pas tout de suite

        } catch (error) {
            console.error(error);
            alert("Erreur de sauvegarde.");
        }
    };

    const handleFileUpload = async (file: File) => {
        // 1. On vÃ©rifie qu'un fichier est sÃ©lectionnÃ©
        if (!file) return;

        setUploadingFile(true);
        setUploadSuccess(null);
        setError('');

        const profileId = keyManager.getProfileId();
        // 2. On prÃ©pare le colis pour le serveur
        const formData = new FormData();
        formData.append('file', file);
        formData.append('profileId', profileId || '');

        try {
            // 3. ON ENVOIE AU SERVEUR (C'est lui qui va lire le PDF)
            const res = await fetch('/api/upload', {
                method: 'POST',
                body: formData,
            });

            const data = await res.json();

            if (!res.ok) {
                throw new Error(data.error || "Erreur inconnue");
            }

            // 4. SuccÃ¨s !
            setUploadSuccess(`SuccÃ¨s : ${data.message || 'Fichier mÃ©morisÃ© !'}`);

            // Recharger les souvenirs
            setTimeout(() => {
                loadMemories();
                setUploadSuccess(null);
            }, 2000);

        } catch (err: any) {
            console.error(err);
            setError("Erreur upload: " + err.message);
        } finally {
            setUploadingFile(false);
        }
    };

    const handleDelete = async (id: string) => {
        if (!confirm("Voulez-vous vraiment effacer ce souvenir ?")) return;

        try {
            const res = await fetch(`/api/memory/delete?id=${id}`, { method: 'DELETE' });
            if (!res.ok) throw new Error("Erreur suppression");

            // Mise Ã  jour immÃ©diate de la liste (optimiste)
            setMemories(prev => prev.filter(m => m.id !== id));

        } catch (error) {
            console.error(error);
            alert("Impossible de supprimer.");
        }
    };

    const handleRespond = async (commId: string, status: 'ACCEPTED' | 'REJECTED') => {
        try {
            // 1. On sauvegarde les infos du contact AVANT de le supprimer de la liste
            const targetContact = notifications.find(n => n.id === commId);

            // 2. Appel Ã  l'API
            const res = await fetch('/api/communications/respond', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ communicationId: commId, status })
            });

            if (!res.ok) throw new Error("Erreur serveur");

            // 3. Mise Ã  jour visuelle (On retire la notif)
            setNotifications(prev => prev.filter(n => n.id !== commId));

            // 4. SI ACCEPTÃ‰ -> ON OUVRE LE TCHAT DIRECTEMENT
            if (status === 'ACCEPTED' && targetContact) {
                setShowNotifPanel(false);   // On ferme les notifs
                setShowContactsPanel(true); // On ouvre le panneau principal
                openChat(targetContact);    // On lance la conversation
            }

        } catch (e) {
            console.error(e);
            alert("Erreur lors de la mise Ã  jour");
        }
    };

    // A. Ouvrir une conversation
    const openChat = async (contact: any) => {
        setActiveConversation(contact);
        // On charge l'historique
        const res = await fetch(`/api/messages?commId=${contact.id}`);
        const data = await res.json();
        if (data.messages) setConversationMessages(data.messages);
    };

    // B. Envoyer un message
    const sendDirectMessage = async () => {
        if (!newMessage.trim() || !activeConversation) return;

        const tempMsg = newMessage;
        setNewMessage(""); // On vide l'input tout de suite (UX)

        const profileId = keyManager.getProfileId();

        try {
            const res = await fetch('/api/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    commId: activeConversation.id,
                    senderId: profileId,
                    content: tempMsg
                })
            });

            const data = await res.json();
            if (data.success) {
                // On ajoute le message Ã  la liste locale pour l'affichage immÃ©diat
                setConversationMessages(prev => [...prev, data.message]);
            }
        } catch (e) {
            alert("Erreur d'envoi");
        }
    };

    // --- FONCTION : NEURO-LINK SAVE ---
    const handleNeuroSave = async () => {
        if (!neuroInput.trim()) return;
        setIsSavingMemory(true);

        const profileId = keyManager.getProfileId();
        if (!profileId) {
            setIsSavingMemory(false);
            return;
        }

        try {
            const res = await fetch('/api/memories/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    content: neuroInput,
                    type: isPrivateMemory ? 'PRIVATE' : 'PUBLIC',
                    profileId: profileId
                })
            });

            if (res.ok) {
                setNeuroInput('');
                // Optionnel : Petit feedback sonore ou visuel
                speak("Souvenir encodÃ©.");
                // Actualisation du Cortex si le tableau est visible
                if (showCortexPanel) openCortex();
            }
        } catch (e) {
            console.error(e);
        } finally {
            setIsSavingMemory(false);
        }
    };

    // ðŸ›‘ GARDIEN COMBINÃ‰ (Pas d'ID ou Pas PrÃªt)
    if (!profileId || !isInitialized) {
        return (
            <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center text-white p-6 relative overflow-hidden">

                {/* Fond dÃ©coratif */}
                <div className="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>

                {/* Si on a l'ID mais qu'on initialise... */}
                {profileId ? (
                    <div className="text-center animate-pulse">
                        <div className="text-4xl mb-4">ðŸ§¬</div>
                        <h2 className="font-mono text-blue-400 text-xl">Synchronisation Neuronale...</h2>
                        <p className="text-slate-500 text-xs mt-2">Initialisation du Cortex</p>
                    </div>
                ) : (
                    /* Si on n'a PAS l'ID (Le formulaire de connexion) */
                    <div className="z-10 bg-slate-900/80 p-8 rounded-2xl border border-slate-700 shadow-2xl max-w-md w-full backdrop-blur-md">
                        <div className="text-center mb-8">
                            <div className="text-6xl mb-4">ðŸ”’</div>
                            <h1 className="text-2xl font-bold font-mono bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
                                ACCÃˆS NEURONAL
                            </h1>
                            <p className="text-slate-400 text-sm mt-2">Identifiant requis.</p>
                        </div>

                        <form
                            onSubmit={(e) => {
                                e.preventDefault();
                                const formData = new FormData(e.currentTarget);
                                const id = formData.get('idInput') as string;
                                if (id) router.push(`/dashboard?profileId=${id}`);
                            }}
                            className="space-y-4"
                        >
                            <input
                                name="idInput"
                                type="text"
                                placeholder="Ex: cml_..."
                                className="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-purple-500 outline-none font-mono text-sm"
                                autoFocus
                            />
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition">
                                CONNEXION
                            </button>
                        </form>
                    </div>
                )}
            </div>
        );
    }

    if (!authorized) return null;

    return (
        <div key={profileId + "_mission"} className="min-h-screen bg-gradient-to-br from-slate-950 via-purple-950/20 to-slate-950 text-white p-4 md:p-6">

            {/* --- NEURO-LINK : BARRE D'ENTRÃ‰E CENTRALE --- */}
            <div className="absolute top-6 left-1/2 transform -translate-x-1/2 w-full max-w-2xl z-50 px-4">
                <div className={`
          relative bg-slate-900/80 backdrop-blur-md border rounded-2xl shadow-2xl transition-all duration-300
          ${isSavingMemory ? 'border-purple-500 shadow-[0_0_20px_rgba(168,85,247,0.3)]' : 'border-slate-700 hover:border-slate-500'}
        `}>

                    <div className="flex items-center p-2">

                        {/* SWITCH PRIVÃ‰ / PUBLIC */}
                        <button
                            onClick={() => setIsPrivateMemory(!isPrivateMemory)}
                            className={`
                flex-shrink-0 p-2 rounded-xl transition-all duration-300 font-bold text-xs mr-2 border
                ${isPrivateMemory
                                    ? 'bg-red-900/30 text-red-400 border-red-500/50 hover:bg-red-900/50'
                                    : 'bg-green-900/30 text-green-400 border-green-500/50 hover:bg-green-900/50'}
              `}
                            title={isPrivateMemory ? "Mode Intime (CryptÃ©)" : "Mode RÃ©seau (Partageable)"}
                        >
                            {isPrivateMemory ? 'ðŸ”’ PRIVÃ‰' : 'ðŸŒ ACTIF'}
                        </button>

                        {/* CHAMP DE SAISIE */}
                        <input
                            type="text"
                            value={neuroInput}
                            onChange={(e) => setNeuroInput(e.target.value)}
                            onKeyDown={(e) => e.key === 'Enter' && handleNeuroSave()}
                            placeholder="Apprenez-moi quelque chose sur vous..."
                            className="flex-1 bg-transparent border-none text-white placeholder-slate-500 focus:outline-none focus:ring-0 text-sm md:text-base font-medium"
                            disabled={isSavingMemory}
                        />

                        {/* BOUTON ENVOYER */}
                        <button
                            onClick={handleNeuroSave}
                            disabled={!neuroInput || isSavingMemory}
                            className={`
                p-2 rounded-xl transition-all duration-300 ml-2
                ${neuroInput
                                    ? 'bg-purple-600 text-white shadow-lg cursor-pointer hover:scale-105'
                                    : 'bg-slate-800 text-slate-600 cursor-not-allowed'}
              `}
                        >
                            {isSavingMemory ? (
                                <span className="animate-spin block">ðŸŒ€</span>
                            ) : (
                                <span>ðŸ’¾</span>
                            )}
                        </button>
                    </div>

                    {/* BARRE DE PROGRESSION (DÃ©coratif) */}
                    <div className="h-0.5 w-full bg-slate-800 rounded-b-2xl overflow-hidden">
                        <div className={`h-full bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 transition-all duration-1000 ${isSavingMemory ? 'w-full' : 'w-0'}`}></div>
                    </div>

                </div>
            </div>

            <div className="max-w-7xl mx-auto">
                {/* Header */}
                <div className="mb-6 border-2 border-purple-500/30 bg-black/50 backdrop-blur p-4 md:p-6 rounded-lg">
                    <div className="flex items-center justify-between flex-wrap gap-4">
                        <div>
                            <h1 className="text-2xl md:text-4xl font-bold mb-2 bg-gradient-to-r from-purple-400 via-pink-500 to-cyan-400 bg-clip-text text-transparent font-mono">
                                â•”â•â•â• MISSION CONTROL â•â•â•â•—
                            </h1>
                            <p className="text-purple-300 text-xs md:text-sm">
                                ðŸ” Architecture Zero-Knowledge â€¢ Protocole Agent Autonome
                            </p>
                        </div>
                        <div className="flex items-center gap-4">
                            {/* --- BOUTON CONTACTS (Juste au dessus de la cloche) --- */}
                            <div className="fixed bottom-24 left-6 z-[9999]">
                                <button
                                    onClick={() => {
                                        setShowContactsPanel(true);
                                        setHasNewContact(false); // On Ã©teint l'alerte quand on clique
                                    }}
                                    className="relative p-4 rounded-full shadow-lg transition transform hover:scale-110"
                                    style={{
                                        backgroundColor: '#0f172a',
                                        border: hasNewContact ? '2px solid #22c55e' : '2px solid #3b82f6', /* Vert si nouveau, Bleu sinon */
                                        color: 'white'
                                    }}
                                    title="Mes Connexions"
                                >
                                    <span style={{ fontSize: '1.5rem' }}>ðŸ‘¥</span>

                                    {/* LE POINT ROUGE CLIGNOTANT (Radar) */}
                                    {hasNewContact && (
                                        <span className="absolute top-0 right-0 flex h-4 w-4">
                                            <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                            <span className="relative inline-flex rounded-full h-4 w-4 bg-green-500"></span>
                                        </span>
                                    )}
                                </button>
                            </div>

                            {/* --- MODALE UNIFIÃ‰E (CONTACTS & TCHAT) --- */}
                            {showContactsPanel && (
                                <div
                                    className="fixed inset-0 z-[100000] flex items-center justify-center p-4"
                                    style={{ backgroundColor: 'rgba(0,0,0,0.85)', backdropFilter: 'blur(5px)' }}
                                >
                                    <div className="w-full max-w-md bg-slate-900 rounded-2xl shadow-2xl overflow-hidden border border-blue-500 h-[500px] flex flex-col animate-in fade-in zoom-in duration-300">

                                        {/* --- CAS 1 : MODE TCHAT --- */}
                                        {activeConversation ? (
                                            <>
                                                {/* Header Tchat */}
                                                <div className="p-3 bg-slate-800 border-b border-blue-500 flex justify-between items-center text-white">
                                                    <button onClick={() => setActiveConversation(null)} className="text-sm text-blue-400 hover:text-white transition">
                                                        â† Retour
                                                    </button>
                                                    <span className="font-mono font-bold text-blue-200">
                                                        ID: {activeConversation.to_clone_id === keyManager.getProfileId()
                                                            ? activeConversation.from_clone_id.slice(0, 6)
                                                            : activeConversation.to_clone_id.slice(0, 6)}...
                                                    </span>
                                                    <button onClick={() => setShowContactsPanel(false)} className="text-slate-500 hover:text-white transition">âœ•</button>
                                                </div>

                                                {/* Zone des Messages */}
                                                <div className="flex-1 overflow-y-auto p-4 bg-slate-900 space-y-3">
                                                    {conversationMessages.length === 0 && (
                                                        <div className="text-center text-slate-600 text-xs mt-10">DÃ©but de la conversation cryptÃ©e.</div>
                                                    )}
                                                    {conversationMessages.map((msg) => {
                                                        const isMe = msg.sender_id === keyManager.getProfileId();
                                                        return (
                                                            <div key={msg.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}>
                                                                <div className={`max-w-[80%] px-3 py-2 rounded-lg text-sm ${isMe
                                                                    ? 'bg-blue-600 text-white rounded-br-none'
                                                                    : 'bg-slate-700 text-slate-200 rounded-bl-none'
                                                                    }`}>
                                                                    {msg.content}
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>

                                                {/* Input Tchat */}
                                                <div className="p-3 bg-slate-800 border-t border-slate-700 flex gap-2">
                                                    <input
                                                        type="text"
                                                        value={newMessage}
                                                        onChange={(e) => setNewMessage(e.target.value)}
                                                        onKeyDown={(e) => e.key === 'Enter' && sendDirectMessage()}
                                                        placeholder="Message sÃ©curisÃ©..."
                                                        className="flex-1 bg-slate-900 text-white border border-slate-600 rounded-full px-4 py-2 text-sm focus:outline-none focus:border-blue-500"
                                                    />
                                                    <button
                                                        onClick={sendDirectMessage}
                                                        className="bg-blue-600 hover:bg-blue-500 text-white rounded-full p-2 w-10 h-10 flex items-center justify-center transition hover:scale-105"
                                                    >
                                                        âž¤
                                                    </button>
                                                </div>
                                            </>
                                        ) : (
                                            /* --- CAS 2 : LISTE DES CONTACTS --- */
                                            <>
                                                <div className="p-4 bg-blue-900/50 border-b border-blue-500 flex justify-between items-center text-white font-bold">
                                                    <h3>ðŸ‘¥ Mes Connexions Actives</h3>
                                                    <button onClick={() => setShowContactsPanel(false)} className="text-slate-400 hover:text-white text-xl">âœ•</button>
                                                </div>

                                                <div className="flex-1 overflow-y-auto p-2">
                                                    {contacts.length === 0 ? (
                                                        <div className="p-8 text-center text-slate-500 italic">
                                                            Aucune connexion active. <br />Lancez une mission ! ðŸš€
                                                        </div>
                                                    ) : (
                                                        contacts.map((contact) => {
                                                            // On dÃ©termine qui est l'autre (si je suis sender, l'autre est receiver)
                                                            const myId = keyManager.getProfileId();
                                                            const otherId = contact.from_clone_id === myId ? contact.to_clone_id : contact.from_clone_id;

                                                            return (
                                                                <div key={contact.id} className="mb-2 bg-slate-800 rounded-lg p-3 border border-slate-700 hover:bg-slate-700 cursor-pointer flex justify-between items-center transition">
                                                                    <div>
                                                                        <div className="text-sm text-blue-300 font-mono">
                                                                            ...{otherId.slice(-8)}
                                                                        </div>
                                                                        <div className="text-xs text-slate-400 truncate w-32">
                                                                            Sujet : {contact.content}
                                                                        </div>
                                                                    </div>
                                                                    <button
                                                                        onClick={() => openChat(contact)}
                                                                        className="px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white text-xs rounded-full"
                                                                    >
                                                                        ðŸ’¬ Discuter
                                                                    </button>
                                                                </div>
                                                            );
                                                        })
                                                    )}
                                                </div>
                                            </>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* --- 1. LE BOUTON CLOCHE (Reste en bas Ã  gauche) --- */}
                            <div className="fixed bottom-6 left-6 z-[9999]">
                                <button
                                    onClick={() => setShowNotifPanel(true)}
                                    className="relative p-4 rounded-full shadow-lg transition transform hover:scale-110 hover:rotate-12"
                                    style={{
                                        backgroundColor: '#1e293b',
                                        border: '2px solid #a855f7',
                                        color: 'white'
                                    }}
                                >
                                    <span style={{ fontSize: '1.5rem' }}>ðŸ””</span>
                                    {notifications.length > 0 && (
                                        <span className="absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center animate-pulse border-2 border-slate-900">
                                            {notifications.length}
                                        </span>
                                    )}
                                </button>
                            </div>

                            {/* --- 2. LA MODALE (OVERLAY) --- */}
                            {showNotifPanel && (
                                <div
                                    className="fixed inset-0 z-[100000] flex items-center justify-center p-4"
                                    style={{ backgroundColor: 'rgba(0,0,0,0.85)', backdropFilter: 'blur(5px)' }}
                                    onClick={(e) => {
                                        if (e.target === e.currentTarget) setShowNotifPanel(false);
                                    }}
                                >
                                    {/* LA BOÃŽTE DE RÃ‰CEPTION CENTRALE */}
                                    <div
                                        className="w-full max-w-md bg-slate-900 rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-300"
                                        style={{ border: '1px solid #a855f7' }}
                                    >
                                        {/* En-tÃªte */}
                                        <div className="p-4 bg-purple-900/50 border-b border-purple-500 flex justify-between items-center">
                                            <h3 className="text-white font-bold text-lg flex items-center gap-2">
                                                ðŸ“¨ BoÃ®te de RÃ©ception
                                                <span className="text-xs bg-purple-600 px-2 py-0.5 rounded-full">{notifications.length}</span>
                                            </h3>
                                            <button
                                                onClick={() => setShowNotifPanel(false)}
                                                className="text-slate-400 hover:text-white transition text-xl font-bold px-2"
                                            >
                                                âœ•
                                            </button>
                                        </div>

                                        {/* Liste des messages */}
                                        <div className="max-h-[60vh] overflow-y-auto p-2">
                                            {notifications.length === 0 ? (
                                                <div className="p-8 text-center text-slate-500 italic">
                                                    Aucun signal entrant pour le moment.
                                                </div>
                                            ) : (
                                                notifications.map((notif) => (
                                                    <div key={notif.id} className="mb-3 bg-slate-800 rounded-xl p-4 border border-slate-700 hover:border-purple-500/50 transition">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <span className="text-xs text-purple-400 font-bold uppercase tracking-wider bg-purple-900/30 px-2 py-1 rounded">
                                                                ðŸ“¡ Signal PING
                                                            </span>
                                                            <span className="text-[10px] text-slate-400">
                                                                {new Date(notif.created_at).toLocaleTimeString()}
                                                            </span>
                                                        </div>

                                                        <p className="text-white mb-3 font-medium text-lg leading-relaxed">
                                                            "{notif.content}"
                                                        </p>

                                                        <div className="text-xs text-slate-400 mb-4 flex items-center gap-2">
                                                            Identifiant source :
                                                            <code className="bg-black/50 px-2 py-1 rounded text-purple-300 font-mono">
                                                                {notif.from_clone_id}
                                                            </code>
                                                        </div>

                                                        {/* BOUTONS D'ACTION */}
                                                        <div className="grid grid-cols-2 gap-3">
                                                            <button
                                                                onClick={() => handleRespond(notif.id, 'ACCEPTED')}
                                                                className="py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg transition shadow-[0_0_15px_rgba(34,197,94,0.3)] flex items-center justify-center gap-2"
                                                            >
                                                                âœ… ACCEPTER
                                                            </button>
                                                            <button
                                                                onClick={() => handleRespond(notif.id, 'REJECTED')}
                                                                className="py-3 bg-slate-700 hover:bg-slate-600 text-slate-200 font-bold rounded-lg transition"
                                                            >
                                                                ðŸ—‘ï¸ IGNORER
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}
                            <Link
                                href="/connections"
                                className="flex items-center gap-2 px-4 py-2 border border-purple-500 text-purple-400 rounded-lg hover:bg-purple-500/10 transition-all font-mono text-sm"
                            >
                                <Network className="w-4 h-4" />
                                <span className="hidden md:inline">GÃ‰RER LES FLUX</span>
                            </Link>
                            <div className="text-right font-mono">
                                <div className="text-xs text-purple-400">STATUT</div>
                                <div className="text-lg text-green-400 font-bold animate-pulse">â— ACTIF</div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Error Display */}
                {error && (
                    <div className="mb-6 border border-red-500 bg-red-900/20 p-4 rounded-lg">
                        <p className="text-red-300">âš  {error}</p>
                    </div>
                )}

                {/* Synchronization Rate Widget */}
                {/* <div key={profileId + "_sync"} className="mb-6 border-2 border-pink-500/40 bg-gradient-to-br from-purple-900/30 via-pink-900/20 to-purple-900/30 backdrop-blur rounded-xl p-6 md:p-8 shadow-2xl shadow-pink-500/10">
                    <div className="flex flex-col md:flex-row items-center justify-between gap-6">
                        
                        <div className="flex-shrink-0">
                            <div className="relative w-32 h-32 md:w-40 md:h-40">
                                
                                <svg className="w-full h-full transform -rotate-90">
                                    <circle
                                        cx="50%"
                                        cy="50%"
                                        r="45%"
                                        fill="none"
                                        stroke="rgba(139, 92, 246, 0.2)"
                                        strokeWidth="8"
                                    />
                                    
                                    <circle
                                        cx="50%"
                                        cy="50%"
                                        r="45%"
                                        fill="none"
                                        stroke="url(#syncGradient)"
                                        strokeWidth="8"
                                        strokeLinecap="round"
                                        strokeDasharray={`${2 * Math.PI * 45} ${2 * Math.PI * 45}`}
                                        strokeDashoffset={2 * Math.PI * 45 * (1 - syncRate / 100)}
                                        className="transition-all duration-1000 ease-out drop-shadow-[0_0_8px_rgba(236,72,153,0.6)]"
                                    />
                                    <defs>
                                        <linearGradient id="syncGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" stopColor="#a855f7" />
                                            <stop offset="50%" stopColor="#ec4899" />
                                            <stop offset="100%" stopColor="#06b6d4" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                
                                <div className="absolute inset-0 flex items-center justify-center">
                                    <span className="text-4xl md:text-5xl font-bold bg-gradient-to-r from-purple-400 via-pink-400 to-cyan-400 bg-clip-text text-transparent">
                                        {syncRate}%
                                    </span>
                                </div>
                            </div>
                        </div>

                        
                        <div className="flex-1 text-center md:text-left">
                            <h2 className="text-2xl md:text-3xl font-bold mb-2 bg-gradient-to-r from-pink-400 to-purple-400 bg-clip-text text-transparent">
                                TAUX DE SYNCHRONISATION
                            </h2>
                            <div className="mb-4">
                                <span className="inline-block px-4 py-2 bg-gradient-to-r from-purple-600/30 to-pink-600/30 border border-pink-500/50 rounded-full text-pink-300 font-bold text-sm md:text-base font-mono">
                                    {syncLevel}
                                </span>
                            </div>

                            
                            <div className="mb-4">
                                <div className="h-3 bg-slate-800/50 rounded-full overflow-hidden border border-purple-500/30">
                                    <div
                                        className="h-full bg-gradient-to-r from-purple-500 via-pink-500 to-cyan-500 transition-all duration-1000 ease-out shadow-[0_0_12px_rgba(236,72,153,0.8)]"
                                        style={{ width: `${syncRate}%` }}
                                    />
                                </div>
                            </div>

                            
                            <div className="flex flex-wrap gap-4 justify-center md:justify-start mb-3 text-sm">
                                <div className="flex items-center gap-2">
                                    <span className="text-green-400">ðŸ§ </span>
                                    <span className="text-purple-300">{memories.length} MÃ©moires</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className="text-blue-400">ðŸ”—</span>
                                    <span className="text-purple-300">{connectedSources} Flux ConnectÃ©s</span>
                                </div>
                            </div>

                            
                            <p className="text-sm text-pink-300/80 italic">
                                {syncRate < 100
                                    ? "âš¡ DonnÃ©es insuffisantes pour l'autonomie totale. Nourrissez le modÃ¨le."
                                    : "âœ¨ SingularitÃ© atteinte. Votre jumeau est pleinement opÃ©rationnel."
                                }
                            </p>
                        </div>
                    </div>
                </div> */}


                {/* Main Grid: 2 Columns */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {/* LEFT: Tabbed Interface (Journal / Chat) */}
                    <div className="space-y-6">

                        {/* âœ… LE NOUVEAU MODULE SÃ‰CURISÃ‰ */}
                        {/* On lui passe le nombre de souvenirs (cortexMemories.length) pour qu'il bouge ! */}
                        <SafeMissionControl count={memories.length} />

                        {/* Tab Switcher */}
                        <div className="flex gap-2 border-2 border-purple-500/30 bg-black/50 backdrop-blur rounded-lg p-2">
                            <Link
                                href={`/dashboard/journal?profileId=${keyManager.getProfileId()}`}
                                className="flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg font-bold font-mono text-sm transition-all bg-transparent border border-green-500/30 text-green-400 hover:bg-green-500/10"
                            >
                                âœï¸ JOURNAL
                            </Link>
                            <button
                                onClick={() => setActiveTab('CHAT')}
                                className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg font-bold font-mono text-sm transition-all ${activeTab === 'CHAT'
                                    ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg shadow-purple-500/30'
                                    : 'bg-transparent border border-purple-500/30 text-purple-400 hover:bg-purple-500/10'
                                    }`}
                            >
                                ðŸ’¬ DIALOGUE
                            </button>
                        </div>

                        {/* SCRIBE TAB */}
                        {activeTab === 'SCRIBE' && (
                            <>
                                <div className="border-2 border-green-500/30 bg-black/50 backdrop-blur rounded-lg p-4 md:p-6">
                                    <div className="flex items-center gap-2 mb-4 border-b border-green-500/30 pb-3">
                                        <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                        <h2 className="text-lg md:text-xl font-bold text-green-400 font-mono">
                                            ðŸ§  JOURNAL NEURONAL
                                        </h2>
                                    </div>

                                    {/* Memory Input */}
                                    <div className="space-y-4">
                                        {/* ZONE INCEPTION MODIFIÃ‰E */}
                                        <div className={`p-4 rounded-xl shadow-sm border transition-colors ${isSecretMode ? 'bg-slate-900 border-red-900/50' : 'bg-white/5 border-green-500/20'
                                            }`}>
                                            <div className="flex justify-between items-center mb-2">
                                                <h3 className={`font-semibold font-mono text-xs ${isSecretMode ? 'text-red-400' : 'text-green-300'
                                                    }`}>
                                                    {isSecretMode ? 'ðŸ”’ LE SCRIBE (COFFRE-FORT)' : 'âš¡ INCEPTION (MÃ‰MOIRE IA)'}
                                                </h3>

                                                {/* LE SWITCH */}
                                                <button
                                                    onClick={() => setIsSecretMode(!isSecretMode)}
                                                    className={`text-[10px] px-2 py-1 rounded-full font-bold transition-all font-mono border ${isSecretMode ? 'bg-red-500/20 text-red-400 border-red-500/50' : 'bg-green-500/20 text-green-400 border-green-500/50'
                                                        }`}
                                                >
                                                    {isSecretMode ? 'MODE SECRET ACTIF' : 'MODE PUBLIC'}
                                                </button>
                                            </div>

                                            <div className="flex gap-2">
                                                <input
                                                    type="text"
                                                    value={quickMemory}
                                                    onChange={(e) => setQuickMemory(e.target.value)}
                                                    placeholder={isSecretMode ? "Mot de passe, Secret..." : "Ex: Le code du wifi est Zx99..."}
                                                    className={`flex-1 p-2 border rounded-lg text-sm outline-none transition-all font-mono ${isSecretMode
                                                        ? 'bg-slate-950/80 border-red-500/30 text-red-100 placeholder-red-500/30 focus:ring-1 focus:ring-red-500'
                                                        : 'bg-slate-900/80 border-green-500/30 text-green-100 placeholder-green-500/30 focus:ring-1 focus:ring-green-500'
                                                        }`}
                                                    onKeyDown={(e) => e.key === 'Enter' && handleQuickAdd()}
                                                />
                                                <button
                                                    onClick={handleQuickAdd}
                                                    className={`px-4 py-2 rounded-lg text-white transition-colors font-bold ${isSecretMode ? 'bg-red-600/20 text-red-400 border border-red-500/50 hover:bg-red-600/40' : 'bg-green-600/20 text-green-400 border border-green-500/50 hover:bg-green-600/40'
                                                        }`}
                                                >
                                                    {isSecretMode ? 'ðŸ”’' : '+'}
                                                </button>
                                            </div>
                                        </div>
                                        {/* --------------------------- */}

                                        <div>
                                            <label className="text-xs text-green-400/70 font-mono mb-2 block">
                                                NOUVELLE MÃ‰MOIRE CHIFFRÃ‰E
                                            </label>
                                            <textarea
                                                value={newMemory}
                                                onChange={(e) => setNewMemory(e.target.value)}
                                                onKeyDown={handleKeyPress}
                                                className="w-full bg-slate-900/50 border border-green-500/30 rounded-lg p-3 md:p-4 text-green-100 placeholder-green-500/30 focus:outline-none focus:ring-2 focus:ring-green-500 font-mono text-sm min-h-[150px] resize-y"
                                                placeholder="[ENTRÃ‰E SÃ‰CURISÃ‰E]&#10;Ctrl+EntrÃ©e pour sauvegarder..."
                                            />
                                        </div>

                                        <div className="flex items-center justify-between">
                                            <div className="text-xs text-green-400/50 font-mono">
                                                ðŸ”’ CHIFFREMENT CLIENT
                                            </div>
                                            <button
                                                onClick={handleSaveMemory}
                                                disabled={saving || !newMemory.trim()}
                                                className="bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold px-4 md:px-6 py-2 md:py-3 rounded-lg hover:from-green-700 hover:to-emerald-700 transition-all disabled:opacity-30 disabled:cursor-not-allowed shadow-lg shadow-green-500/20 font-mono text-sm"
                                            >
                                                {saving ? '[CHIFFREMENT...]' : '[MÃ‰MORISER]'}
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* File Upload Section */}
                                <div className="border-2 border-purple-500/30 bg-gradient-to-br from-purple-900/20 via-pink-900/10 to-purple-900/20 backdrop-blur rounded-lg p-4 md:p-6">
                                    <div className="text-xs text-purple-400/70 font-mono mb-3 border-b border-purple-500/30 pb-2">
                                        OU IMPORTER UN FICHIER
                                    </div>

                                    <div
                                        onDrop={(e) => {
                                            e.preventDefault();
                                            const file = e.dataTransfer.files[0];
                                            if (file) handleFileUpload(file);
                                        }}
                                        onDragOver={(e) => e.preventDefault()}
                                        className="border-2 border-dashed border-purple-500/50 rounded-lg p-6 text-center hover:border-purple-500 transition-colors cursor-pointer bg-purple-900/10 hover:bg-purple-900/20"
                                    >
                                        {uploadingFile ? (
                                            <div className="text-purple-400 font-mono text-sm">
                                                <div className="animate-pulse mb-2 flex items-center justify-center gap-2">
                                                    <span className="inline-block w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></span>
                                                    <span className="inline-block w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></span>
                                                    <span className="inline-block w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></span>
                                                    <span className="ml-2">Analyse du cortex...</span>
                                                </div>
                                                <div className="text-xs text-purple-400/50">Vectorisation en cours</div>
                                            </div>
                                        ) : uploadSuccess ? (
                                            <div className="text-green-400 font-mono text-sm animate-pulse">
                                                âœ“ {uploadSuccess}
                                            </div>
                                        ) : (
                                            <>
                                                <div className="text-purple-400 font-mono text-sm mb-2">
                                                    ðŸ“„ Glissez vos documents ici
                                                </div>
                                                <div className="text-xs text-purple-400/50 mb-3">
                                                    TXT, MD, Logs, PDF
                                                </div>
                                                <input
                                                    type="file"
                                                    accept=".txt,.md,.log,.pdf"
                                                    onChange={(e) => {
                                                        const file = e.target.files?.[0];
                                                        if (file) handleFileUpload(file);
                                                    }}
                                                    className="hidden"
                                                    id="file-upload"
                                                />
                                                <label
                                                    htmlFor="file-upload"
                                                    className="inline-block px-4 py-2 bg-purple-600/30 border border-purple-500/50 rounded text-purple-300 text-xs font-mono hover:bg-purple-600/50 cursor-pointer transition-all"
                                                >
                                                    ou cliquez pour parcourir
                                                </label>
                                            </>
                                        )}
                                    </div>
                                </div>

                                {/* Bloc Journal Neuronal (Lien vers la page dÃ©diÃ©e) */}
                                <div className="bg-white/5 p-6 rounded-xl shadow-sm border border-green-500/20 text-center hover:border-green-500/50 transition-colors">
                                    <div className="mb-4">
                                        <span className="text-4xl filter drop-shadow-[0_0_10px_rgba(74,222,128,0.5)]">ðŸ§ </span>
                                    </div>
                                    <h3 className="text-lg font-bold text-green-100 mb-2 font-mono">GESTION DU CORTEX</h3>
                                    <p className="text-green-400/70 text-sm mb-6 font-mono">
                                        Consultez, modifiez et nettoyez les souvenirs de votre Jumeau pour affiner sa personnalitÃ©.
                                    </p>

                                    <Link
                                        href={`/dashboard/cortex?profileId=${keyManager.getProfileId()}`}
                                        className="inline-flex items-center px-6 py-3 bg-green-600/20 text-green-300 border border-green-500/50 rounded-lg hover:bg-green-600/40 transition-all font-bold font-mono shadow-[0_0_15px_rgba(74,222,128,0.1)] hover:shadow-[0_0_20px_rgba(74,222,128,0.3)]"
                                    >
                                        ACCÃ‰DER AU CORTEX MANAGER â†’
                                    </Link>
                                </div>
                            </>
                        )}

                        {/* CHAT TAB */}
                        {activeTab === 'CHAT' && (
                            <div className="border-2 border-purple-500/30 bg-black/50 backdrop-blur rounded-lg p-4 md:p-6">
                                <div className="flex items-center gap-2 mb-4 border-b border-purple-500/30 pb-3">
                                    <div className="w-2 h-2 bg-purple-400 rounded-full animate-pulse"></div>
                                    <h2 className="text-lg md:text-xl font-bold text-purple-400 font-mono">
                                        ðŸ’¬ DIALOGUE AVEC LE JUMEAU
                                    </h2>
                                </div>

                                {/* Chat Messages */}
                                <div
                                    ref={chatRef}
                                    className="h-[500px] overflow-y-auto space-y-4 mb-4 p-2"
                                >
                                    {chatMessages.length === 0 ? (
                                        <div className="flex items-center justify-center h-full text-center">
                                            <div className="text-purple-400/50 font-mono text-sm">
                                                <p className="mb-2">ðŸ¤– Jumeau en attente...</p>
                                                <p className="text-xs">Posez-moi une question sur vos souvenirs</p>
                                            </div>
                                        </div>
                                    ) : (
                                        chatMessages.map((msg, idx) => (
                                            <div
                                                key={idx}
                                                className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
                                            >
                                                <div
                                                    className={`max-w-[80%] rounded-lg p-3 ${msg.role === 'user'
                                                        ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white'
                                                        : 'bg-slate-800 text-green-100 border border-green-500/30'
                                                        }`}
                                                >
                                                    <p className="text-sm whitespace-pre-wrap">{msg.content}</p>
                                                    {msg.timestamp && (
                                                        <div className={`text-xs mt-2 ${msg.role === 'user' ? 'text-purple-200' : 'text-green-400/50'} font-mono`}>
                                                            {new Date(msg.timestamp).toLocaleTimeString('fr-FR')}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))
                                    )}

                                    {/* Thinking Indicator */}
                                    {isThinking && (
                                        <div className="flex justify-start">
                                            <div className="bg-slate-800 border border-purple-500/30 rounded-lg p-3">
                                                <div className="flex items-center gap-2">
                                                    <div className="flex gap-1">
                                                        <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                                                        <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
                                                        <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
                                                    </div>
                                                    <span className="text-purple-300 text-sm font-mono">Le jumeau rÃ©flÃ©chit...</span>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Chat Input */}
                                <div className="flex gap-2">
                                    {/* BOUTON MICRO */}
                                    <button
                                        onClick={isListening ? undefined : startListening}
                                        className={`p-3 rounded-lg transition-all ${isListening
                                            ? 'bg-red-500 text-white animate-pulse'
                                            : 'bg-slate-100 text-slate-500 hover:bg-slate-200'
                                            }`}
                                        title="Parler"
                                    >
                                        {isListening ? 'ðŸ‘‚' : 'ðŸŽ™ï¸'}
                                    </button>

                                    <input
                                        type="text"
                                        value={chatInput}
                                        onChange={(e) => setChatInput(e.target.value)}
                                        onKeyPress={handleChatKeyPress}
                                        disabled={isThinking}
                                        className="flex-1 bg-slate-900/50 border border-purple-500/30 rounded-lg p-3 text-purple-100 placeholder-purple-500/30 focus:outline-none focus:ring-2 focus:ring-purple-500 font-mono text-sm disabled:opacity-50"
                                        placeholder="Parlez Ã  votre jumeau..."
                                    />
                                    <button
                                        onClick={handleSendMessage}
                                        disabled={isThinking || !chatInput.trim()}
                                        className="bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold px-6 py-3 rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all disabled:opacity-30 disabled:cursor-not-allowed shadow-lg shadow-purple-500/20 font-mono text-sm"
                                    >
                                        {isThinking ? '...' : 'ENVOYER'}
                                    </button>
                                    {/* BOUTON MISSION */}
                                    <button
                                        onClick={handleMission}
                                        disabled={isThinking || !chatInput.trim()}
                                        className="p-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 transition-colors shadow-lg"
                                        title="Lancer une Mission (Recherche RÃ©seau)"
                                    >
                                        ðŸš€
                                    </button>
                                    {/* BOUTON PING (n'apparaÃ®t que si on a trouvÃ© quelqu'un) */}
                                    {lastFoundClone && (
                                        <button
                                            onClick={handlePing}
                                            className="p-3 bg-green-600 text-white rounded-lg hover:bg-green-700 animate-bounce shadow-lg"
                                            title="Envoyer un Ping au dernier profil trouvÃ©"
                                        >
                                            ðŸ“¡
                                        </button>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* RIGHT: Shadow Network */}
                    <div className="space-y-6">
                        {/* 3D Globe */}
                        <div className="border-2 border-purple-500/30 bg-black/50 backdrop-blur rounded-lg p-4 md:p-6">
                            <div className="flex items-center gap-2 mb-4 border-b border-purple-500/30 pb-3">
                                <div className="w-2 h-2 bg-purple-400 rounded-full animate-pulse"></div>
                                <h2 className="text-lg md:text-xl font-bold text-purple-400 font-mono">
                                    ðŸŒ RÃ‰SEAU OMBRE
                                </h2>
                            </div>

                            <ShadowGlobe onLocationChange={handleLocationChange} />
                        </div>

                        {/* Live Terminal */}
                        <div className="border-2 border-cyan-500/30 bg-black/50 backdrop-blur rounded-lg p-4 md:p-6">
                            <div className="flex items-center gap-2 mb-4 border-b border-cyan-500/30 pb-3">
                                <div className="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div>
                                <h2 className="text-lg md:text-xl font-bold text-cyan-400 font-mono">
                                    ðŸ’» TERMINAL LIVE
                                </h2>
                            </div>

                            <div
                                ref={terminalRef}
                                className="bg-black/90 border border-cyan-500/20 rounded p-3 md:p-4 h-[300px] overflow-y-auto font-mono text-xs space-y-1"
                            >
                                {logs.map((log, idx) => (
                                    <div key={idx} className="text-green-400">
                                        {log}
                                    </div>
                                ))}
                                <div className="text-green-400 animate-pulse inline-block">â–Š</div>
                            </div>
                        </div>
                    </div>


                    {/* Footer */}
                    <div className="mt-6 text-center text-xs text-purple-400/50 font-mono">
                        DIGITAL TWIN v2.0 â€¢ VISUALISATION COBE â€¢ SURVEILLANCE RÃ‰SEAU TEMPS RÃ‰EL
                    </div>
                </div>
            </div>

            {/* --- 3. BOUTON CORTEX MANAGER RAPIDE (AccÃ¨s direct) --- */}
            <div className="fixed bottom-44 left-6 z-[9999]">
                <button
                    onClick={openCortex}
                    className="relative p-4 rounded-full shadow-lg transition transform hover:scale-110 group"
                    style={{
                        backgroundColor: '#0f172a',
                        border: '2px solid #a855f7',
                        color: 'white'
                    }}
                    title="GÃ©rer la MÃ©moire (Cortex)"
                >
                    <span className="text-2xl group-hover:animate-pulse">ðŸ§ </span>
                    {/* Badge compteur */}
                    <span className="absolute -top-1 -right-1 bg-purple-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border border-purple-400">
                        ADM
                    </span>
                </button>
            </div>

            {/* --- MODALE CORTEX MANAGER (PLEIN Ã‰CRAN) --- */}
            {showCortexPanel && (
                <div
                    className="fixed inset-0 z-[100000] flex items-center justify-center p-4 animate-in fade-in duration-300"
                    style={{ backgroundColor: 'rgba(0,0,0,0.9)', backdropFilter: 'blur(5px)' }}
                >
                    <div className="w-full max-w-4xl bg-slate-900 rounded-2xl shadow-2xl overflow-hidden border border-purple-500 flex flex-col max-h-[90vh]">

                        {/* EN-TÃŠTE */}
                        <div className="p-4 bg-purple-900/50 border-b border-purple-500 flex justify-between items-center">
                            <div>
                                <h2 className="text-xl font-bold text-white flex items-center gap-2 font-mono">
                                    âš™ï¸ Cortex Manager <span className="text-xs bg-purple-600 px-2 rounded-full">{cortexMemories.length}</span>
                                </h2>
                                <p className="text-xs text-purple-200 font-mono">ADMINISTRATION DIRECTE DE LA BASE VECTORIELLE</p>
                            </div>
                            <button
                                onClick={() => setShowCortexPanel(false)}
                                className="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg transition"
                            >
                                Fermer âœ•
                            </button>
                        </div>

                        {/* BARRE DE RECHERCHE */}
                        <div className="p-4 bg-slate-800 border-b border-slate-700">
                            <input
                                type="text"
                                placeholder="ðŸ” Rechercher un fragment de mÃ©moire Ã  supprimer..."
                                value={cortexSearch}
                                onChange={(e) => setCortexSearch(e.target.value)}
                                className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white focus:border-purple-500 focus:outline-none font-mono text-sm"
                            />
                        </div>

                        {/* TABLEAU DES SOUVENIRS */}
                        <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                            <table className="w-full text-left text-sm text-slate-400">
                                <thead className="text-xs uppercase bg-slate-950 text-slate-500 sticky top-0 font-mono">
                                    <tr>
                                        <th className="px-4 py-3 rounded-tl-lg">Type</th>
                                        <th className="px-4 py-3">Contenu</th>
                                        <th className="px-4 py-3">Date</th>
                                        <th className="px-4 py-3 text-right rounded-tr-lg">Action</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-800">
                                    {filteredCortex.length === 0 ? (
                                        <tr>
                                            <td colSpan={4} className="p-8 text-center text-slate-500 italic">Aucune donnÃ©e trouvÃ©e.</td>
                                        </tr>
                                    ) : (
                                        filteredCortex.map((mem) => (
                                            <tr key={mem.id} className="hover:bg-slate-800/50 transition">
                                                <td className="px-4 py-3">
                                                    {mem.metadata?.type === 'PRIVATE' ? (
                                                        <span className="text-red-400 border border-red-900 bg-red-900/20 px-2 py-0.5 rounded text-xs font-mono">ðŸ”’ PRIVÃ‰</span>
                                                    ) : (
                                                        <span className="text-green-400 border border-green-900 bg-green-900/20 px-2 py-0.5 rounded text-xs font-mono">ðŸŒ ACTIF</span>
                                                    )}
                                                </td>
                                                <td className="px-4 py-3 text-slate-200 font-medium max-w-md truncate">
                                                    {mem.content}
                                                </td>
                                                <td className="px-4 py-3 font-mono text-xs">
                                                    {new Date(mem.created_at).toLocaleDateString()}
                                                </td>
                                                <td className="px-4 py-3 text-right">
                                                    <button
                                                        onClick={() => handleDeleteMemory(mem.id)}
                                                        className="text-slate-500 hover:text-red-500 hover:bg-red-900/20 p-2 rounded transition"
                                                        title="Supprimer dÃ©finitivement"
                                                    >
                                                        ðŸ—‘ï¸
                                                    </button>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\dashboard\cortex\page.tsx ---

'use client';
import { useState, useEffect } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';

export default function CortexManager() {
    const searchParams = useSearchParams();
    const profileId = searchParams.get('profileId');
    const router = useRouter(); // Pour rediriger si besoin

    const [memories, setMemories] = useState<any[]>([]);
    const [searchTerm, setSearchTerm] = useState('');
    const [isLoading, setIsLoading] = useState(true);

    // --- GARDIEN DE SÃ‰CURITÃ‰ ---
    // Si pas d'ID, on affiche un Ã©cran de verrouillage au lieu de crasher
    if (!profileId) {
        return (
            <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center text-white p-4">
                <div className="text-6xl mb-4">ðŸ”’</div>
                <h1 className="text-2xl font-bold font-mono text-red-500 mb-2">ACCÃˆS REFUSÃ‰</h1>
                <p className="text-slate-400 mb-8 text-center max-w-md">
                    Identifiant de clone manquant. Le protocole de sÃ©curitÃ© empÃªche l'accÃ¨s au Cortex sans authentification biomÃ©trique (ID).
                </p>
                <button
                    onClick={() => router.push('/dashboard')} // Ou vers votre page de login
                    className="bg-slate-800 hover:bg-slate-700 border border-slate-600 px-6 py-3 rounded-lg transition text-sm font-mono"
                >
                    RETOURNER AU SAS D'ENTRÃ‰E
                </button>
            </div>
        );
    }

    // --- CHARGEMENT ---
    const fetchMemories = async () => {
        setIsLoading(true);
        try {
            const res = await fetch(`/api/memories?profileId=${profileId}`);
            const data = await res.json();
            if (data.memories) setMemories(data.memories);
        } catch (e) {
            console.error(e);
        } finally {
            setIsLoading(false);
        }
    };

    useEffect(() => { if (profileId) fetchMemories(); }, [profileId]);

    // --- SUPPRESSION ---
    const handleDelete = async (id: string) => {
        if (!confirm("âš ï¸ ATTENTION : Cette action est irrÃ©versible.\nCe souvenir sera effacÃ© de la mÃ©moire du clone.")) {
            return;
        }

        try {
            const res = await fetch('/api/memories/delete', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });

            const data = await res.json();

            if (data.success) {
                // Mise Ã  jour locale (plus rapide que de tout recharger)
                setMemories(prev => prev.filter(m => m.id !== id));
            } else {
                alert("Erreur: " + data.error);
            }
        } catch (e) {
            alert("Erreur technique lors de la suppression.");
        }
    };

    // Filtrage pour la recherche
    const filteredMemories = memories.filter(m =>
        m.content.toLowerCase().includes(searchTerm.toLowerCase())
    );

    return (
        <div className="min-h-screen bg-slate-950 text-white p-8 font-sans">

            {/* HEADER TECHNIQUE */}
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8 border-b border-slate-800 pb-6">
                <div>
                    <h1 className="text-2xl font-bold font-mono text-purple-400 flex items-center gap-2">
                        âš™ï¸ CORTEX_MANAGER_V1
                    </h1>
                    <p className="text-slate-500 text-sm mt-1">
                        Interface d'administration de la base vectorielle.
                    </p>
                </div>

                {/* STATS RAPIDES */}
                <div className="flex gap-4">
                    <div className="bg-slate-900 border border-slate-700 px-4 py-2 rounded text-center">
                        <div className="text-xl font-bold text-white">{memories.length}</div>
                        <div className="text-[10px] uppercase text-slate-500 tracking-wider">Fragments</div>
                    </div>
                    <div className="bg-slate-900 border border-slate-700 px-4 py-2 rounded text-center">
                        <div className="text-xl font-bold text-green-400">
                            {memories.filter(m => m.metadata?.type !== 'PRIVATE').length}
                        </div>
                        <div className="text-[10px] uppercase text-slate-500 tracking-wider">Publics</div>
                    </div>
                    <div className="bg-slate-900 border border-slate-700 px-4 py-2 rounded text-center">
                        <div className="text-xl font-bold text-red-400">
                            {memories.filter(m => m.metadata?.type === 'PRIVATE').length}
                        </div>
                        <div className="text-[10px] uppercase text-slate-500 tracking-wider">PrivÃ©s</div>
                    </div>
                </div>
            </div>

            {/* BARRE D'OUTILS */}
            <div className="flex gap-4 mb-6">
                <input
                    type="text"
                    placeholder="ðŸ” Rechercher une sÃ©quence mÃ©moire..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white focus:border-purple-500 focus:outline-none font-mono text-sm"
                />
                <button
                    onClick={fetchMemories}
                    className="bg-slate-800 hover:bg-slate-700 border border-slate-600 px-4 rounded-lg transition"
                    title="RafraÃ®chir"
                >
                    ðŸ”„
                </button>
            </div>

            {/* TABLEAU DE DONNÃ‰ES */}
            <div className="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden shadow-xl">
                <div className="overflow-x-auto">
                    <table className="w-full text-left text-sm text-slate-400">
                        <thead className="bg-slate-950 text-slate-200 uppercase font-mono text-xs">
                            <tr>
                                <th className="px-6 py-4">Statut</th>
                                <th className="px-6 py-4">Contenu (Raw Data)</th>
                                <th className="px-6 py-4">Date d'injection</th>
                                <th className="px-6 py-4 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-800">
                            {isLoading ? (
                                <tr>
                                    <td colSpan={4} className="px-6 py-10 text-center text-slate-500 animate-pulse">
                                        Chargement des donnÃ©es neuronales...
                                    </td>
                                </tr>
                            ) : filteredMemories.length === 0 ? (
                                <tr>
                                    <td colSpan={4} className="px-6 py-10 text-center text-slate-600 italic">
                                        Aucune donnÃ©e trouvÃ©e dans le secteur.
                                    </td>
                                </tr>
                            ) : (
                                filteredMemories.map((mem) => (
                                    <tr key={mem.id} className="hover:bg-slate-800/50 transition group">

                                        {/* COLONNE STATUT */}
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            {mem.metadata?.type === 'PRIVATE' ? (
                                                <span className="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-900/30 text-red-400 border border-red-900/50">
                                                    ðŸ”’ PRIVÃ‰
                                                </span>
                                            ) : (
                                                <span className="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-900/30 text-green-400 border border-green-900/50">
                                                    ðŸŒ ACTIF
                                                </span>
                                            )}
                                        </td>

                                        {/* COLONNE CONTENU */}
                                        <td className="px-6 py-4">
                                            <div className="max-w-xl truncate text-slate-200 font-medium">
                                                {mem.content}
                                            </div>
                                            <div className="text-xs text-slate-600 font-mono mt-1">
                                                ID: {mem.id.slice(0, 8)}...
                                            </div>
                                        </td>

                                        {/* COLONNE DATE */}
                                        <td className="px-6 py-4 whitespace-nowrap font-mono text-xs">
                                            {new Date(mem.created_at).toLocaleDateString()}
                                            <span className="text-slate-600 ml-2">
                                                {new Date(mem.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                            </span>
                                        </td>

                                        {/* COLONNE ACTION */}
                                        <td className="px-6 py-4 text-right">
                                            <button
                                                onClick={() => handleDelete(mem.id)}
                                                className="text-slate-500 hover:text-red-500 hover:bg-red-900/20 p-2 rounded transition"
                                                title="Supprimer dÃ©finitivement"
                                            >
                                                ðŸ—‘ï¸
                                            </button>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\dashboard\journal\page.tsx ---

'use client';
import { useState, useEffect } from 'react';
import { useSearchParams } from 'next/navigation';

export default function JournalPage() {
    const searchParams = useSearchParams();
    const profileId = searchParams.get('profileId');

    const [memories, setMemories] = useState<any[]>([]);
    const [input, setInput] = useState('');
    const [isPrivate, setIsPrivate] = useState(false); // Le switch simple
    const [isLoading, setIsLoading] = useState(false);

    // --- CHARGEMENT ---
    const fetchMemories = async () => {
        const res = await fetch(`/api/memories?profileId=${profileId}`);
        const data = await res.json();
        if (data.memories) setMemories(data.memories);
    };

    useEffect(() => { if (profileId) fetchMemories(); }, [profileId]);

    // --- Ã‰CRITURE RAPIDE (Ex-Inception) ---
    const handleSubmit = async () => {
        if (!input.trim()) return;
        setIsLoading(true);

        try {
            await fetch('/api/ingest', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    text: input,
                    profileId,
                    // C'est ici que Ã§a se joue : on envoie le tag TYPE
                    type: isPrivate ? 'PRIVATE' : 'PUBLIC'
                })
            });
            setInput('');
            fetchMemories(); // Mise Ã  jour immÃ©diate du flux
        } catch (e) {
            alert("Erreur");
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="h-full flex flex-col bg-slate-950 text-white font-sans max-w-4xl mx-auto p-4">

            {/* 1. ZONE DE SAISIE (L'Inception simplifiÃ©e) */}
            <div className="bg-slate-900 border border-slate-800 rounded-2xl p-4 shadow-xl mb-8 relative z-10">
                <textarea
                    value={input}
                    onChange={(e) => setInput(e.target.value)}
                    placeholder="Ã€ quoi pensez-vous ? (Souvenir, Info, Secret...)"
                    className="w-full bg-transparent text-lg text-white placeholder-slate-500 focus:outline-none resize-none h-20"
                />

                <div className="flex justify-between items-center mt-3 pt-3 border-t border-slate-800">

                    {/* LE SWITCH MAGIQUE : Cadenas ou Globe */}
                    <button
                        onClick={() => setIsPrivate(!isPrivate)}
                        className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold transition ${isPrivate
                                ? 'bg-red-900/30 text-red-400 border border-red-500/50'
                                : 'bg-green-900/30 text-green-400 border border-green-500/50'
                            }`}
                    >
                        {isPrivate ? (
                            <>ðŸ”’ STICTEMENT PRIVÃ‰ (Intime)</>
                        ) : (
                            <>ðŸŒ RÃ‰SEAU (Utilisable pour Match)</>
                        )}
                    </button>

                    <button
                        onClick={handleSubmit}
                        disabled={!input || isLoading}
                        className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-xl font-bold transition shadow-lg disabled:opacity-50"
                    >
                        {isLoading ? 'Encodage...' : 'MÃ©moriser'}
                    </button>
                </div>
            </div>

            {/* 2. LE FLUX (Journal) */}
            <div className="flex-1 overflow-y-auto space-y-4 pr-2 custom-scrollbar">
                <h3 className="text-slate-500 text-sm font-bold uppercase tracking-widest mb-2">
                    Flux Neuronal ({memories.length})
                </h3>

                {memories.map((mem) => (
                    <div key={mem.id} className="group flex gap-4 animate-in fade-in slide-in-from-bottom-2 duration-300">

                        {/* La Timeline visuelle Ã  gauche */}
                        <div className="flex flex-col items-center">
                            <div className={`w-3 h-3 rounded-full border-2 ${mem.type === 'PRIVATE' ? 'bg-red-500 border-red-900' : 'bg-green-500 border-green-900'
                                }`}></div>
                            <div className="w-0.5 flex-1 bg-slate-800 group-last:bg-transparent my-1"></div>
                        </div>

                        {/* La Carte du souvenir */}
                        <div className="flex-1 pb-6">
                            <div className="bg-slate-900/50 border border-slate-800 hover:border-slate-600 rounded-xl p-4 transition relative">

                                <div className="flex justify-between items-start mb-2">
                                    <span className="text-xs text-slate-500 font-mono">
                                        {new Date(mem.created_at).toLocaleDateString()} â€¢ {new Date(mem.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                    </span>
                                    {mem.type === 'PRIVATE' && <span className="text-xs text-red-500">ðŸ”’ CryptÃ©</span>}
                                </div>

                                <p className="text-slate-200 leading-relaxed whitespace-pre-wrap">
                                    {mem.content}
                                </p>

                                {/* Actions au survol */}
                                <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition">
                                    <button className="text-slate-600 hover:text-red-400 p-1">ðŸ—‘ï¸</button>
                                </div>
                            </div>
                        </div>
                    </div>
                ))}

                {memories.length === 0 && (
                    <div className="text-center py-20 text-slate-600 italic">
                        Votre journal est vide. Ã‰crivez votre premiÃ¨re pensÃ©e ci-dessus.
                    </div>
                )}
            </div>
        </div>
    );
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\memories\page.tsx ---

'use client';

import { useState, useEffect, Suspense } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import { cryptoManager } from '@/lib/security/crypto';

function MemoriesContent() {
    const searchParams = useSearchParams();
    const router = useRouter();
    const profileId = searchParams.get('profileId');

    const [memories, setMemories] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);
    const [editingId, setEditingId] = useState<string | null>(null);
    const [editContent, setEditContent] = useState('');

    // 1. Chargement des souvenirs
    useEffect(() => {
        if (!profileId) return;
        // USING SINGULAR /api/memory based on file verification
        fetch(`/api/memory?profileId=${profileId}`)
            .then(res => res.json())
            .then(data => {
                setMemories(Array.isArray(data) ? data : []);
                setLoading(false);
            });
    }, [profileId]);

    // 2. Fonction de Suppression
    const handleDelete = async (id: string) => {
        if (!confirm("Voulez-vous vraiment effacer ce souvenir dÃ©finitivement ?")) return;
        setMemories(prev => prev.filter(m => m.id !== id)); // Optimiste
        await fetch(`/api/memory/delete?id=${id}`, { method: 'DELETE' });
    };

    // 3. Fonction de Modification (Start)
    const startEdit = (memory: any) => {
        setEditingId(memory.id);
        setEditContent(memory.content);
    };

    // 4. Sauvegarde de la Modification
    const saveEdit = async (id: string) => {
        // Optimiste : on met Ã  jour l'affichage tout de suite
        setMemories(prev => prev.map(m => m.id === id ? { ...m, content: editContent } : m));
        setEditingId(null);

        await fetch('/api/memory/update', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, content: editContent })
        });
    };

    // 5. DÃ©chiffrement Ã  la volÃ©e
    const handleUnlock = async (id: string, encryptedContent: string) => {
        try {
            const clearText = await cryptoManager.decrypt(encryptedContent);
            // On met Ã  jour l'affichage localement pour montrer le texte clair
            setMemories(prev => prev.map(m =>
                m.id === id ? { ...m, content: clearText, isDecrypted: true } : m
            ));
        } catch (e) {
            alert("Erreur de dÃ©chiffrement (ClÃ© invalide ?)");
        }
    };

    if (!profileId) return <div className="p-10 text-center">Profil non identifiÃ©.</div>;

    return (
        <div className="min-h-screen bg-slate-50 p-8 font-sans">
            <div className="max-w-4xl mx-auto">

                {/* EN-TÃŠTE */}
                <div className="flex items-center justify-between mb-8">
                    <div>
                        <h1 className="text-3xl font-bold text-slate-800">ðŸ§  Cortex Manager</h1>
                        <p className="text-slate-500">Gestion de la mÃ©moire Ã  long terme</p>
                    </div>
                    <Link
                        href={`/dashboard?profileId=${profileId}`}
                        className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition"
                    >
                        â† Retour au Cockpit
                    </Link>
                </div>

                {/* LISTE */}
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    {loading ? (
                        <div className="p-8 text-center text-slate-400">Chargement des neurones...</div>
                    ) : memories.length === 0 ? (
                        <div className="p-8 text-center text-slate-400">Aucun souvenir trouvÃ©. Le cerveau est vide.</div>
                    ) : (
                        <table className="w-full text-left border-collapse">
                            <thead className="bg-slate-50 text-slate-500 text-xs uppercase font-semibold">
                                <tr>
                                    <th className="p-4 border-b">Type</th>
                                    <th className="p-4 border-b w-full">Contenu du souvenir</th>
                                    <th className="p-4 border-b whitespace-nowrap">Date</th>
                                    <th className="p-4 border-b text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {memories.map((m) => (
                                    <tr key={m.id} className="hover:bg-slate-50 transition">

                                        {/* TYPE (Icone) */}
                                        <td className="p-4 align-top">
                                            <span className={`inline-block px-2 py-1 rounded text-xs font-medium ${m.tags?.includes('upload') ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'
                                                }`}>
                                                {m.tags?.includes('upload') ? 'DOC' : 'NOTE'}
                                            </span>
                                        </td>

                                        {/* CONTENU INTELLIGENT */}
                                        <td className="p-4 align-top">
                                            {editingId === m.id ? (
                                                <textarea
                                                    className="w-full p-2 border rounded-md focus:ring-2 focus:ring-indigo-500 outline-none text-slate-800"
                                                    rows={3}
                                                    value={editContent}
                                                    onChange={(e) => setEditContent(e.target.value)}
                                                />
                                            ) : (
                                                // LOGIQUE D'AFFICHAGE SÃ‰CURISÃ‰
                                                m.type === 'secret' && !m.isDecrypted ? (
                                                    <div className="flex items-center gap-3">
                                                        <div className="bg-slate-100 p-3 rounded text-slate-400 italic text-xs border border-slate-200 w-full max-w-md">
                                                            ðŸ”’ Contenu chiffrÃ© (Illisible pour l'IA)
                                                        </div>
                                                        <button
                                                            onClick={() => handleUnlock(m.id, m.content)}
                                                            className="text-xs bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-full hover:bg-indigo-200 transition font-medium"
                                                        >
                                                            DÃ©verrouiller ðŸ”“
                                                        </button>
                                                    </div>
                                                ) : (
                                                    // Affichage normal (ou secret dÃ©chiffrÃ©)
                                                    <p className={`whitespace-pre-wrap text-sm leading-relaxed ${m.isDecrypted ? 'text-green-700 font-medium bg-green-50 p-2 rounded' : 'text-slate-700'
                                                        }`}>
                                                        {m.content}
                                                    </p>
                                                )
                                            )}
                                        </td>

                                        {/* DATE */}
                                        <td className="p-4 align-top text-xs text-slate-400 whitespace-nowrap">
                                            {new Date(m.createdAt).toLocaleDateString()}
                                            <br />
                                            {new Date(m.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                        </td>

                                        {/* ACTIONS */}
                                        <td className="p-4 align-top text-right space-x-2">
                                            {editingId === m.id ? (
                                                <>
                                                    <button onClick={() => saveEdit(m.id)} className="text-green-600 hover:text-green-800 font-medium text-sm">Sauver</button>
                                                    <button onClick={() => setEditingId(null)} className="text-slate-400 hover:text-slate-600 text-sm">Annuler</button>
                                                </>
                                            ) : (
                                                <>
                                                    <button onClick={() => startEdit(m)} className="text-indigo-500 hover:text-indigo-700 text-sm">Ã‰diter</button>
                                                    <button onClick={() => handleDelete(m.id)} className="text-red-400 hover:text-red-600 text-sm ml-2">Supprimer</button>
                                                </>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </div>

            </div>
        </div>
    );
}

export default function MemoriesPage() {
    return (
        <Suspense fallback={<div>Chargement...</div>}>
            <MemoriesContent />
        </Suspense>
    );
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\profile\new\page.tsx ---

'use client';

/**
 * New Profile Creation Page
 * Allows users to create a new digital twin profile with Zero-Knowledge encryption
 */

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { generateMnemonic } from 'bip39';
import {
    generateSalt,
    hashPassword,
    deriveKey,
    encryptObject,
    arrayToBase64,
} from '@/lib/crypto/zk-encryption';

export default function NewProfilePage() {
    const router = useRouter();
    const [step, setStep] = useState<'form' | 'recovery'>('form');
    const [formData, setFormData] = useState({
        name: '',
        masterPassword: '',
        confirmPassword: '',
    });
    const [recoveryPhrase, setRecoveryPhrase] = useState<string>('');
    const [profileId, setProfileId] = useState<string>('');
    const [isCreating, setIsCreating] = useState(false);
    const [error, setError] = useState<string>('');
    const [phraseConfirmed, setPhraseConfirmed] = useState(false);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');

        // Validation
        if (formData.name.length < 2) {
            setError('Le nom doit contenir au moins 2 caractÃ¨res');
            return;
        }

        if (formData.masterPassword.length < 12) {
            setError('Le mot de passe maÃ®tre doit contenir au moins 12 caractÃ¨res');
            return;
        }

        if (formData.masterPassword !== formData.confirmPassword) {
            setError('Les mots de passe ne correspondent pas');
            return;
        }

        setIsCreating(true);

        try {
            // ===== CLIENT-SIDE CRYPTOGRAPHY (Zero-Knowledge) =====

            // 1. Generate cryptographic salt
            const salt = generateSalt();
            const saltBase64 = arrayToBase64(salt);

            // 2. Generate BIP39 recovery phrase (12 words)
            const generatedRecoveryPhrase = generateMnemonic(128); // 128 bits = 12 words

            // 3. Hash the password for verification (not for encryption!)
            const passwordHash = hashPassword(formData.masterPassword, salt);

            // 4. Generate unique vector namespace for this profile
            const vectorNamespace = `profile_${Date.now()}_${Math.random().toString(36).substring(7)}`;

            // 5. Derive master key from password
            const masterKey = await deriveKey(formData.masterPassword, salt);

            // 6. Create and encrypt initial metadata
            const metadata = {
                preferences: {},
                settings: {},
                createdBy: 'digital-twin-profile-system',
                version: '1.0.0',
            };
            const encryptedMetadata = await encryptObject(metadata, masterKey);

            // 7. Encrypt recovery phrase
            const encryptedPhrase = await encryptObject(
                { phrase: generatedRecoveryPhrase },
                masterKey
            );

            // ===== SEND ONLY ENCRYPTED DATA TO SERVER =====
            const response = await fetch('/api/profile/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: formData.name,
                    passwordHash,
                    saltBase64,
                    encryptedMetadata,
                    encryptedPhrase,
                    vectorNamespace,
                }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Ã‰chec de la crÃ©ation du profil');
            }

            const data = await response.json();

            // Store recovery phrase (generated client-side, never sent to server)
            setRecoveryPhrase(generatedRecoveryPhrase);
            setProfileId(data.profileId);
            setStep('recovery');
        } catch (err: any) {
            setError(err.message);
        } finally {
            setIsCreating(false);
        }
    };

    const handleCopyPhrase = () => {
        navigator.clipboard.writeText(recoveryPhrase);
        alert('Phrase de rÃ©cupÃ©ration copiÃ©e dans le presse-papiers');
    };

    const handleConfirmAndContinue = () => {
        if (!phraseConfirmed) {
            alert('Veuillez confirmer que vous avez sauvegardÃ© votre phrase de rÃ©cupÃ©ration');
            return;
        }
        router.push(`/profile/unlock?id=${profileId}`);
    };

    if (step === 'recovery') {
        return (
            <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4">
                <div className="max-w-2xl w-full bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl border border-white/20 p-8">
                    <div className="text-center mb-8">
                        <div className="w-20 h-20 bg-gradient-to-br from-green-400 to-emerald-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                            <svg className="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <h1 className="text-3xl font-bold text-white mb-2">Profil CrÃ©Ã© avec SuccÃ¨s !</h1>
                        <p className="text-purple-200">Votre jumeau numÃ©rique est maintenant initialisÃ©</p>
                    </div>

                    <div className="bg-red-500/20 border border-red-400 rounded-lg p-6 mb-6">
                        <div className="flex items-start gap-3">
                            <svg className="w-6 h-6 text-red-300 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <div>
                                <h3 className="text-red-200 font-bold mb-2">âš ï¸ CRITIQUE : Sauvegardez Votre Phrase de RÃ©cupÃ©ration</h3>
                                <p className="text-red-100 text-sm">
                                    Cette phrase de 12 mots est la SEULE faÃ§on de rÃ©cupÃ©rer votre profil si vous oubliez votre mot de passe.
                                    <strong className="block mt-2">Perte de cette phrase = Perte IRRÃ‰VERSIBLE de toutes vos donnÃ©es.</strong>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div className="bg-slate-800/50 rounded-lg p-6 mb-6">
                        <div className="flex items-center justify-between mb-3">
                            <h3 className="text-white font-semibold">Phrase de RÃ©cupÃ©ration BIP39</h3>
                            <button
                                onClick={handleCopyPhrase}
                                className="text-purple-300 hover:text-purple-200 text-sm flex items-center gap-1"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                                Copier
                            </button>
                        </div>
                        <div className="grid grid-cols-3 gap-3">
                            {recoveryPhrase.split(' ').map((word, index) => (
                                <div key={index} className="bg-slate-700/50 rounded px-3 py-2 text-center">
                                    <span className="text-purple-300 text-xs">{index + 1}.</span>
                                    <span className="text-white font-mono ml-2">{word}</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="mb-6">
                        <label className="flex items-center gap-3 cursor-pointer">
                            <input
                                type="checkbox"
                                checked={phraseConfirmed}
                                onChange={(e) => setPhraseConfirmed(e.target.checked)}
                                className="w-5 h-5 rounded border-purple-400 text-purple-600 focus:ring-purple-500"
                            />
                            <span className="text-white text-sm">
                                J'ai sauvegardÃ© ma phrase de rÃ©cupÃ©ration en lieu sÃ»r et je comprends qu'elle ne peut pas Ãªtre rÃ©cupÃ©rÃ©e
                            </span>
                        </label>
                    </div>

                    <button
                        onClick={handleConfirmAndContinue}
                        disabled={!phraseConfirmed}
                        className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold py-3 rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Continuer vers le Profil
                    </button>

                    <p className="text-purple-200 text-xs text-center mt-4">
                        ID du Profil : <span className="font-mono">{profileId}</span>
                    </p>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4">
            <div className="max-w-md w-full bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl border border-white/20 p-8">
                <div className="text-center mb-8">
                    <div className="w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                        <svg className="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>
                    <h1 className="text-3xl font-bold text-white mb-2">Nouveau Jumeau NumÃ©rique</h1>
                    <p className="text-purple-200">CrÃ©ez votre profil sÃ©curisÃ© avec chiffrement Zero-Knowledge</p>
                </div>

                {error && (
                    <div className="bg-red-500/20 border border-red-400 rounded-lg p-3 mb-4">
                        <p className="text-red-200 text-sm">{error}</p>
                    </div>
                )}

                <form onSubmit={handleSubmit} className="space-y-5">
                    <div>
                        <label className="block text-purple-200 text-sm font-medium mb-2">
                            Nom du Profil
                        </label>
                        <input
                            type="text"
                            value={formData.name}
                            onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                            className="w-full bg-white/5 border border-purple-300/30 rounded-lg px-4 py-3 text-white placeholder-purple-300/50 focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="Ex: Mon Jumeau Personnel"
                            required
                        />
                    </div>

                    <div>
                        <label className="block text-purple-200 text-sm font-medium mb-2">
                            Mot de Passe MaÃ®tre (min. 12 caractÃ¨res)
                        </label>
                        <input
                            type="password"
                            value={formData.masterPassword}
                            onChange={(e) => setFormData({ ...formData, masterPassword: e.target.value })}
                            className="w-full bg-white/5 border border-purple-300/30 rounded-lg px-4 py-3 text-white placeholder-purple-300/50 focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                            minLength={12}
                            required
                        />
                        <p className="text-purple-300/70 text-xs mt-1">
                            Ce mot de passe ne sera JAMAIS stockÃ© sur le serveur
                        </p>
                    </div>

                    <div>
                        <label className="block text-purple-200 text-sm font-medium mb-2">
                            Confirmer le Mot de Passe
                        </label>
                        <input
                            type="password"
                            value={formData.confirmPassword}
                            onChange={(e) => setFormData({ ...formData, confirmPassword: e.target.value })}
                            className="w-full bg-white/5 border border-purple-300/30 rounded-lg px-4 py-3 text-white placeholder-purple-300/50 focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                            minLength={12}
                            required
                        />
                    </div>

                    <div className="bg-blue-500/20 border border-blue-400/50 rounded-lg p-4">
                        <h3 className="text-blue-200 font-semibold text-sm mb-2">ðŸ” SÃ©curitÃ© Zero-Knowledge</h3>
                        <ul className="text-blue-100 text-xs space-y-1">
                            <li>âœ“ Chiffrement AES-256-GCM cÃ´tÃ© client</li>
                            <li>âœ“ Vos clÃ©s ne quittent jamais votre appareil</li>
                            <li>âœ“ Le serveur ne peut pas lire vos donnÃ©es</li>
                            <li>âœ“ Phrase de rÃ©cupÃ©ration BIP39 (12 mots)</li>
                        </ul>
                    </div>

                    <button
                        type="submit"
                        disabled={isCreating}
                        className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold py-3 rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    >
                        {isCreating ? (
                            <>
                                <svg className="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                                </svg>
                                CrÃ©ation en cours...
                            </>
                        ) : (
                            'CrÃ©er le Profil'
                        )}
                    </button>
                </form>

                <div className="mt-6 text-center">
                    <a href="/" className="text-purple-300 hover:text-purple-200 text-sm">
                        â† Retour Ã  l'accueil
                    </a>
                </div>
            </div>
        </div>
    );
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\app\profile\unlock\page.tsx ---

'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { base64ToArray, verifyPassword } from '@/lib/crypto/zk-encryption';
import { keyManager } from '@/lib/crypto/key-manager';

function UnlockContent() {
    const router = useRouter();
    const searchParams = useSearchParams();
    const urlId = searchParams.get('id');

    const [step, setStep] = useState<'ID_INPUT' | 'PASSWORD_INPUT'>(urlId ? 'PASSWORD_INPUT' : 'ID_INPUT');
    const [manualId, setManualId] = useState('');
    const [password, setPassword] = useState('');
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');
    const [profileData, setProfileData] = useState<any>(null);

    // The active profile ID (either from URL or manual input)
    const activeId = urlId || manualId;

    useEffect(() => {
        if (activeId) {
            fetch(`/api/profile/${activeId}`)
                .then(res => {
                    if (!res.ok) throw new Error('Profil introuvable');
                    return res.json();
                })
                .then(setProfileData)
                .catch(err => setError(err.message));
        }
    }, [activeId]);

    const handleIdSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');

        if (!manualId.trim()) {
            setError('Veuillez entrer un ID de profil');
            return;
        }

        setLoading(true);
        try {
            const res = await fetch(`/api/profile/${manualId}`);
            if (!res.ok) throw new Error('Profil introuvable');
            const data = await res.json();
            setProfileData(data);
            setStep('PASSWORD_INPUT');
        } catch (err: any) {
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };

    const handlePasswordSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        try {
            if (!profileData) throw new Error("Profil non chargÃ©");

            const salt = base64ToArray(profileData.saltBase64);
            // const isValid = verifyPassword(password, salt, profileData.passwordHash);
            console.log("âš ï¸ BYPASS ACTIVÃ‰ : Connexion forcÃ©e");
            const isValid = true;

            if (!isValid) throw new Error("Mot de passe incorrect");

            // Initialiser la session sÃ©curisÃ©e en mÃ©moire
            await keyManager.initializeSession(profileData.id, password, salt);

            // Save to localStorage for future quick access
            localStorage.setItem('twins_last_id', profileData.id);
            localStorage.setItem('twins_last_name', profileData.name);

            router.push('/dashboard');
        } catch (err: any) {
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };

    // Step 1: ID Input
    if (step === 'ID_INPUT') {
        return (
            <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                <div className="max-w-md w-full bg-white/10 backdrop-blur rounded-2xl p-8 border border-white/20">
                    <h1 className="text-2xl font-bold text-white mb-2 text-center">Connexion Manuelle</h1>
                    <p className="text-purple-300 text-sm text-center mb-6">Entrez votre ID de profil</p>

                    {error && <div className="bg-red-500/20 text-red-200 p-3 rounded mb-4">{error}</div>}

                    <form onSubmit={handleIdSubmit} className="space-y-4">
                        <input
                            type="text"
                            value={manualId}
                            onChange={(e) => setManualId(e.target.value)}
                            className="w-full bg-black/20 border border-purple-500/30 rounded p-3 text-white font-mono text-sm"
                            placeholder="clxxx..."
                            autoFocus
                        />
                        <button
                            disabled={loading}
                            className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded transition"
                        >
                            {loading ? 'VÃ©rification...' : 'Continuer'}
                        </button>
                    </form>
                </div>
            </div>
        );
    }

    // Step 2: Password Input
    if (!profileData) {
        return <div className="text-white text-center mt-20">Chargement du profil...</div>;
    }

    return (
        <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
            <div className="max-w-md w-full bg-white/10 backdrop-blur rounded-2xl p-8 border border-white/20">
                <h1 className="text-2xl font-bold text-white mb-2 text-center">DÃ©verrouiller {profileData.name}</h1>
                <p className="text-purple-300 text-xs text-center mb-6 font-mono">ID: {profileData.id.slice(0, 12)}...</p>

                {error && <div className="bg-red-500/20 text-red-200 p-3 rounded mb-4">{error}</div>}

                <form onSubmit={handlePasswordSubmit} className="space-y-4">
                    <input
                        type="password"
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        className="w-full bg-black/20 border border-purple-500/30 rounded p-3 text-white"
                        placeholder="Mot de passe maÃ®tre"
                        autoFocus
                    />
                    <button
                        disabled={loading}
                        className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded transition"
                    >
                        {loading ? 'DÃ©chiffrement...' : 'AccÃ©der au Jumeau'}
                    </button>

                    {!urlId && (
                        <button
                            type="button"
                            onClick={() => {
                                setStep('ID_INPUT');
                                setPassword('');
                                setError('');
                            }}
                            className="w-full text-purple-300 hover:text-white text-sm transition"
                        >
                            â† Retour
                        </button>
                    )}
                </form>
            </div>
        </div>
    );
}

export default function UnlockPage() {
    return (
        <Suspense fallback={<div>Chargement...</div>}>
            <UnlockContent />
        </Suspense>
    );
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\components\shadow-globe.tsx ---

'use client';
import { useEffect, useRef, useState } from 'react';
import createGlobe from 'cobe';

interface City {
    name: string;
    lat: number;
    long: number;
}

const TECH_HUBS: City[] = [
    { name: 'Tokyo', lat: 35.6762, long: 139.6503 },
    { name: 'San Francisco', lat: 37.7749, long: -122.4194 },
    { name: 'Londres', lat: 51.5074, long: -0.1278 },
    { name: 'SÃ©oul', lat: 37.5665, long: 126.9780 },
    { name: 'Paris', lat: 48.8566, long: 2.3522 },
    { name: 'DubaÃ¯', lat: 25.2048, long: 55.2708 },
    { name: 'Singapour', lat: 1.3521, long: 103.8198 },
    { name: 'New York', lat: 40.7128, long: -74.0060 },
];

interface ShadowGlobeProps {
    onLocationChange?: (city: string) => void;
}

export default function ShadowGlobe({ onLocationChange }: ShadowGlobeProps) {
    const canvasRef = useRef<HTMLCanvasElement>(null);
    const [currentCity, setCurrentCity] = useState<City>(TECH_HUBS[0]);
    const pointerInteracting = useRef<number | null>(null);
    const pointerInteractionMovement = useRef(0);
    const [r, setR] = useState(0);

    useEffect(() => {
        let phi = 0;
        let width = 0;
        const onResize = () => canvasRef.current && (width = canvasRef.current.offsetWidth);
        window.addEventListener('resize', onResize);
        onResize();

        if (!canvasRef.current) return;

        const globe = createGlobe(canvasRef.current, {
            devicePixelRatio: 2,
            width: width * 2,
            height: width * 2,
            phi: 0,
            theta: 0.3,
            dark: 1,
            diffuse: 1.2,
            mapSamples: 16000,
            mapBrightness: 6,
            baseColor: [0.1, 0.1, 0.2],
            markerColor: [0.8, 0.2, 0.8],
            glowColor: [0.4, 0.1, 0.5],
            markers: [
                // Current location marker (large)
                { location: [currentCity.lat, currentCity.long] as [number, number], size: 0.1 },
                // All tech hub markers (small)
                ...TECH_HUBS.map(city => ({
                    location: [city.lat, city.long] as [number, number],
                    size: 0.04
                }))
            ],
            onRender: (state) => {
                // Auto-rotation
                if (!pointerInteracting.current) {
                    phi += 0.003;
                }
                state.phi = phi + r;

                // Update size on resize
                state.width = width * 2;
                state.height = width * 2;
            }
        });

        setTimeout(() => canvasRef.current && (canvasRef.current.style.opacity = '1'));

        return () => {
            globe.destroy();
            window.removeEventListener('resize', onResize);
        };
    }, [currentCity, r]);

    // Change location every 5 seconds
    useEffect(() => {
        const interval = setInterval(() => {
            const randomIndex = Math.floor(Math.random() * TECH_HUBS.length);
            const newCity = TECH_HUBS[randomIndex];

            // Only change if different
            if (newCity.name !== currentCity.name) {
                setCurrentCity(newCity);

                if (onLocationChange) {
                    onLocationChange(newCity.name);
                }
            }
        }, 5000);

        return () => clearInterval(interval);
    }, [currentCity, onLocationChange]);

    return (
        <div className="relative w-full aspect-square">
            <canvas
                ref={canvasRef}
                onPointerDown={(e) => {
                    pointerInteracting.current = e.clientX - pointerInteractionMovement.current;
                    canvasRef.current && (canvasRef.current.style.cursor = 'grabbing');
                }}
                onPointerUp={() => {
                    pointerInteracting.current = null;
                    canvasRef.current && (canvasRef.current.style.cursor = 'grab');
                }}
                onPointerOut={() => {
                    pointerInteracting.current = null;
                    canvasRef.current && (canvasRef.current.style.cursor = 'grab');
                }}
                onMouseMove={(e) => {
                    if (pointerInteracting.current !== null) {
                        const delta = e.clientX - pointerInteracting.current;
                        pointerInteractionMovement.current = delta;
                        setR(delta / 200);
                    }
                }}
                onTouchMove={(e) => {
                    if (pointerInteracting.current !== null && e.touches[0]) {
                        const delta = e.touches[0].clientX - pointerInteracting.current;
                        pointerInteractionMovement.current = delta;
                        setR(delta / 100);
                    }
                }}
                style={{
                    width: '100%',
                    height: '100%',
                    cursor: 'grab',
                    contain: 'layout paint size',
                    opacity: 0,
                    transition: 'opacity 1s ease'
                }}
            />

            {/* Current Location Indicator */}
            <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-purple-900/90 border border-purple-500 px-4 py-2 rounded backdrop-blur-sm">
                <div className="text-xs text-purple-300 font-mono">
                    ðŸ“ NÅ’UD ACTIF
                </div>
                <div className="text-sm text-purple-100 font-bold font-mono">
                    {currentCity.name.toUpperCase()}
                </div>
            </div>
        </div>
    );
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\lib\crypto\key-manager.ts ---

/**
 * Key Manager - Secure Session-Based Key Storage
 * 
 * Manages encryption keys in memory during a user session.
 * Keys are never persisted to disk or localStorage.
 */

import { deriveKey, generateSalt, arrayToBase64, base64ToArray } from './zk-encryption';

interface KeySession {
    masterKey: CryptoKey;
    profileId: string;
    salt: Uint8Array;
    createdAt: number;
    lastAccessedAt: number;
}

class KeyManager {
    private session: KeySession | null = null;
    private readonly AUTO_LOCK_TIMEOUT = 30 * 60 * 1000; // 30 minutes

    /**
     * Initializes a new key session from a master password
     */
    async initializeSession(
        profileId: string,
        masterPassword: string,
        salt: Uint8Array
    ): Promise<void> {
        const masterKey = await deriveKey(masterPassword, salt);

        this.session = {
            masterKey,
            profileId,
            salt,
            createdAt: Date.now(),
            lastAccessedAt: Date.now(),
        };
    }

    /**
     * Gets the current master key
     * @throws Error if session is not initialized or expired
     */
    getMasterKey(): CryptoKey {
        this.checkSession();
        this.session!.lastAccessedAt = Date.now();
        return this.session!.masterKey;
    }

    /**
     * Gets the current profile ID
     */
    getProfileId(): string {
        this.checkSession();
        return this.session!.profileId;
    }

    /**
     * Gets the salt for the current session
     */
    getSalt(): Uint8Array {
        this.checkSession();
        return this.session!.salt;
    }

    /**
     * Checks if a session is active and not expired
     */
    isSessionActive(): boolean {
        if (!this.session) return false;

        const timeSinceLastAccess = Date.now() - this.session.lastAccessedAt;
        if (timeSinceLastAccess > this.AUTO_LOCK_TIMEOUT) {
            this.lockSession();
            return false;
        }

        return true;
    }

    /**
     * Locks the current session (clears keys from memory)
     */
    lockSession(): void {
        this.session = null;
    }

    /**
     * Derives a specialized key for a specific purpose
     * This allows different keys for data encryption, embeddings, etc.
     */
    async deriveSpecializedKey(purpose: string): Promise<CryptoKey> {
        this.checkSession();

        // Create a unique salt by combining the session salt with the purpose
        const purposeBuffer = new TextEncoder().encode(purpose);
        const combinedSalt = new Uint8Array(this.session!.salt.length + purposeBuffer.length);
        combinedSalt.set(this.session!.salt, 0);
        combinedSalt.set(purposeBuffer, this.session!.salt.length);

        // Derive a new key using the combined salt
        const specializedKey = await crypto.subtle.deriveKey(
            {
                name: 'PBKDF2',
                salt: combinedSalt,
                iterations: 100000,
                hash: 'SHA-256',
            },
            this.session!.masterKey,
            { name: 'AES-GCM', length: 256 },
            false,
            ['encrypt', 'decrypt']
        );

        return specializedKey;
    }

    /**
     * Checks if session is valid, throws if not
     */
    private checkSession(): void {
        if (!this.isSessionActive()) {
            throw new Error('Session expired or not initialized. Please unlock your profile.');
        }
    }

    /**
     * Gets session info (without exposing the key)
     */
    getSessionInfo(): { profileId: string; createdAt: number; lastAccessedAt: number } | null {
        if (!this.session) return null;

        return {
            profileId: this.session.profileId,
            createdAt: this.session.createdAt,
            lastAccessedAt: this.session.lastAccessedAt,
        };
    }
}

// Singleton instance
export const keyManager = new KeyManager();



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\lib\crypto\zk-encryption.ts ---

// Fix build dependencies Vercel
/**
 * Zero-Knowledge Encryption Module
 * 
 * Implements AES-256-GCM encryption with PBKDF2 key derivation.
 * All encryption happens client-side. The server never sees the encryption key.
 */

import { pbkdf2 } from '@noble/hashes/pbkdf2.js';
import { sha256 } from '@noble/hashes/sha2.js';

const PBKDF2_ITERATIONS = 100000;
const SALT_LENGTH = 32;
const IV_LENGTH = 12; // GCM standard IV length
const KEY_LENGTH = 32; // 256 bits

/**
 * Derives an encryption key from a master password using PBKDF2
 */
export async function deriveKey(
  masterPassword: string,
  salt: Uint8Array
): Promise<CryptoKey> {
  // Use PBKDF2 to derive key material
  const keyMaterial = pbkdf2(sha256, masterPassword, salt, {
    c: PBKDF2_ITERATIONS,
    dkLen: KEY_LENGTH,
  });

  // Import the key material as a CryptoKey for Web Crypto API
  // Create a new Uint8Array to ensure proper ArrayBuffer type
  return await crypto.subtle.importKey(
    'raw',
    new Uint8Array(keyMaterial),
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt', 'decrypt']
  );
}

/**
 * Generates a cryptographically secure random salt
 */
export function generateSalt(): Uint8Array {
  return crypto.getRandomValues(new Uint8Array(SALT_LENGTH));
}

/**
 * Generates a cryptographically secure random IV
 */
export function generateIV(): Uint8Array {
  return crypto.getRandomValues(new Uint8Array(IV_LENGTH));
}

/**
 * Encrypts data using AES-256-GCM
 * 
 * @param data - The plaintext data to encrypt
 * @param key - The encryption key (derived from master password)
 * @returns Encrypted data with IV prepended (IV + ciphertext + auth tag)
 */
export async function encrypt(
  data: string,
  key: CryptoKey
): Promise<string> {
  const iv = generateIV();
  const encoder = new TextEncoder();
  const dataBuffer = encoder.encode(data);

  // Encrypt using AES-GCM (includes authentication tag)
  const encryptedBuffer = await crypto.subtle.encrypt(
    {
      name: 'AES-GCM',
      iv: new Uint8Array(iv),
    },
    key,
    dataBuffer
  );

  // Combine IV + encrypted data for storage
  const combined = new Uint8Array(iv.length + encryptedBuffer.byteLength);
  combined.set(iv, 0);
  combined.set(new Uint8Array(encryptedBuffer), iv.length);

  // Return as base64 for easy storage
  return btoa(String.fromCharCode.apply(null, Array.from(combined)));
}

/**
 * Decrypts data encrypted with AES-256-GCM
 * 
 * @param encryptedData - Base64 encoded encrypted data (IV + ciphertext + auth tag)
 * @param key - The decryption key (same as encryption key)
 * @returns Decrypted plaintext
 * @throws Error if decryption fails (wrong key or tampered data)
 */
export async function decrypt(
  encryptedData: string,
  key: CryptoKey
): Promise<string> {
  try {
    // Decode from base64
    const combined = Uint8Array.from(atob(encryptedData), c => c.charCodeAt(0));

    // Extract IV and encrypted data
    const iv = combined.slice(0, IV_LENGTH);
    const encryptedBuffer = combined.slice(IV_LENGTH);

    // Decrypt using AES-GCM (verifies authentication tag)
    const decryptedBuffer = await crypto.subtle.decrypt(
      {
        name: 'AES-GCM',
        iv: new Uint8Array(iv),
      },
      key,
      encryptedBuffer
    );

    const decoder = new TextDecoder();
    return decoder.decode(decryptedBuffer);
  } catch (error) {
    throw new Error('Decryption failed: Invalid key or corrupted data');
  }
}

/**
 * Hashes a master password to create a verification hash
 * This hash is stored in the database to verify the password without storing the key
 */
export function hashPassword(password: string, salt: Uint8Array): string {
  const hash = pbkdf2(sha256, password, salt, {
    c: PBKDF2_ITERATIONS,
    dkLen: 32,
  });
  return btoa(String.fromCharCode.apply(null, Array.from(hash)));
}

/**
 * Verifies a password against a stored hash
 */
export function verifyPassword(
  password: string,
  salt: Uint8Array,
  storedHash: string
): boolean {
  const computedHash = hashPassword(password, salt);
  return computedHash === storedHash;
}

/**
 * Encrypts an object by converting it to JSON first
 */
export async function encryptObject<T>(
  obj: T,
  key: CryptoKey
): Promise<string> {
  const json = JSON.stringify(obj);
  return await encrypt(json, key);
}

/**
 * Decrypts an encrypted object
 */
export async function decryptObject<T>(
  encryptedData: string,
  key: CryptoKey
): Promise<T> {
  const json = await decrypt(encryptedData, key);
  return JSON.parse(json) as T;
}

/**
 * Converts a Uint8Array to a base64 string for storage
 */
export function arrayToBase64(array: Uint8Array): string {
  return btoa(String.fromCharCode.apply(null, Array.from(array)));
}

/**
 * Converts a base64 string back to a Uint8Array
 */
export function base64ToArray(base64: string): Uint8Array {
  return Uint8Array.from(atob(base64), c => c.charCodeAt(0));
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\lib\db\supabase.ts ---

/**
 * Supabase Client Configuration
 * Configured for Zero-Knowledge architecture with pgvector support
 */

import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

if (!supabaseUrl || !supabaseAnonKey) {
    throw new Error(
        'Missing Supabase environment variables. Please set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY'
    );
}

export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
    auth: {
        persistSession: true,
        autoRefreshToken: true,
    },
});

/**
 * Server-side Supabase client with service role key
 * Use only in API routes for admin operations
 */
export function getSupabaseAdmin() {
    const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;

    if (!supabaseServiceKey) {
        throw new Error('Missing SUPABASE_SERVICE_ROLE_KEY environment variable');
    }

    return createClient(supabaseUrl, supabaseServiceKey, {
        auth: {
            persistSession: false,
            autoRefreshToken: false,
        },
    });
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\lib\hooks\use-speech.ts ---

import { useState, useEffect, useRef } from 'react';

export function useSpeech() {
    const [isListening, setIsListening] = useState(false);
    const [transcript, setTranscript] = useState('');
    const [isSpeaking, setIsSpeaking] = useState(false);

    // RÃ©fÃ©rence pour la reconnaissance vocale
    const recognitionRef = useRef<any>(null);

    useEffect(() => {
        // Initialisation (seulement cÃ´tÃ© client)
        if (typeof window !== 'undefined' && 'webkitSpeechRecognition' in window) {
            // @ts-ignore
            const recognition = new window.webkitSpeechRecognition();
            recognition.continuous = false; // On arrÃªte d'Ã©couter quand la phrase finit
            recognition.lang = 'fr-FR';
            recognition.interimResults = false;

            recognition.onstart = () => setIsListening(true);
            recognition.onend = () => setIsListening(false);

            recognition.onresult = (event: any) => {
                const text = event.results[0][0].transcript;
                setTranscript(text);
            };

            recognitionRef.current = recognition;
        }
    }, []);

    // DÃ©marrer l'Ã©coute
    const startListening = () => {
        if (recognitionRef.current) {
            setTranscript(''); // Reset
            recognitionRef.current.start();
        } else {
            alert("Votre navigateur ne supporte pas la reconnaissance vocale.");
        }
    };

    // ArrÃªter l'Ã©coute
    const stopListening = () => {
        if (recognitionRef.current) recognitionRef.current.stop();
    };

    // Faire parler le Jumeau
    const speak = (text: string) => {
        if ('speechSynthesis' in window) {
            // On arrÃªte s'il parle dÃ©jÃ 
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'fr-FR';
            utterance.rate = 1.0; // Vitesse normale
            utterance.pitch = 1.0; // TonalitÃ© normale

            utterance.onstart = () => setIsSpeaking(true);
            utterance.onend = () => setIsSpeaking(false);

            window.speechSynthesis.speak(utterance);
        }
    };

    return {
        isListening,
        transcript,
        startListening,
        stopListening,
        speak,
        isSpeaking
    };
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\lib\profile\profile-manager.ts ---

/**
 * Profile Manager
 * Handles creation, management, and isolation of digital twin profiles
 */

import { PrismaClient } from '@prisma/client';
import { base64ToArray, verifyPassword } from '../crypto/zk-encryption';
import { keyManager } from '../crypto/key-manager';

const prisma = new PrismaClient();

export interface ProfileCreationData {
    name: string;
    passwordHash: string;
    saltBase64: string;
    encryptedMetadata: string;
    encryptedPhrase: string;
    vectorNamespace: string;
}

export interface ProfileCreationResult {
    profileId: string;
}

export interface DigitalTwinProfile {
    id: string;
    name: string;
    createdAt: Date;
    vectorNamespace: string;
}

export class ProfileManager {
    /**
     * Creates a new digital twin profile with Zero-Knowledge encryption
     * All cryptographic operations are performed CLIENT-SIDE
     * This method only persists pre-encrypted data
     */
    async createProfile(data: ProfileCreationData): Promise<ProfileCreationResult> {
        // Validate that we received encrypted data (basic sanity check)
        if (!data.passwordHash || !data.saltBase64 || !data.encryptedMetadata || !data.encryptedPhrase) {
            throw new Error('Missing required encrypted data fields');
        }

        // Create profile in database with pre-encrypted data
        const profile = await prisma.profile.create({
            data: {
                name: data.name,
                saltBase64: data.saltBase64,
                passwordHash: data.passwordHash,
                encryptedMetadata: data.encryptedMetadata,
                vectorNamespace: data.vectorNamespace,
            },
        });

        // Store encrypted recovery phrase
        await prisma.recoveryPhrase.create({
            data: {
                profileId: profile.id,
                encryptedPhrase: data.encryptedPhrase,
                phraseHash: data.passwordHash, // Use same hash for verification
            },
        });

        console.log(`âœ… Profile created: ${profile.id} (${data.name})`);
        console.log(`ðŸ“¦ Vector namespace: ${data.vectorNamespace}`);
        console.log(`ðŸ” Zero-Knowledge: All data encrypted client-side`);

        return {
            profileId: profile.id,
        };
    }

    /**
     * Unlocks a profile with master password
     * Initializes the key manager session
     */
    async unlockProfile(profileId: string, masterPassword: string): Promise<boolean> {
        const profile = await prisma.profile.findUnique({
            where: { id: profileId },
        });

        if (!profile) {
            throw new Error('Profile not found');
        }

        const salt = base64ToArray(profile.saltBase64);

        // Verify password
        if (!verifyPassword(masterPassword, salt, profile.passwordHash)) {
            return false;
        }

        // Initialize session
        await keyManager.initializeSession(profileId, masterPassword, salt);

        // Update last accessed time
        await prisma.profile.update({
            where: { id: profileId },
            data: { lastAccessedAt: new Date() },
        });

        console.log(`ðŸ”“ Profile unlocked: ${profileId}`);

        return true;
    }

    /**
     * Lists all available profiles (non-sensitive data only)
     */
    async listProfiles(): Promise<DigitalTwinProfile[]> {
        const profiles = await prisma.profile.findMany({
            select: {
                id: true,
                name: true,
                createdAt: true,
                vectorNamespace: true,
            },
            orderBy: {
                lastAccessedAt: 'desc',
            },
        });

        return profiles;
    }

    /**
     * Gets the current active profile from session
     */
    getCurrentProfile(): string | null {
        const sessionInfo = keyManager.getSessionInfo();
        return sessionInfo?.profileId || null;
    }

    /**
     * Locks the current profile session
     */
    lockProfile(): void {
        keyManager.lockSession();
        console.log('ðŸ”’ Profile locked');
    }

    /**
     * Deletes a profile and all associated data
     * IRREVERSIBLE OPERATION
     */
    async deleteProfile(profileId: string, masterPassword: string): Promise<void> {
        // Verify password before deletion
        const isValid = await this.unlockProfile(profileId, masterPassword);

        if (!isValid) {
            throw new Error('Invalid password. Cannot delete profile.');
        }

        // Delete all memories (cascade will handle this via Prisma schema)
        // Delete recovery phrase
        await prisma.recoveryPhrase.deleteMany({
            where: { profileId },
        });

        // Delete profile
        await prisma.profile.delete({
            where: { id: profileId },
        });

        // Lock session
        keyManager.lockSession();

        console.log(`ðŸ—‘ï¸ Profile deleted: ${profileId}`);
    }

    /**
     * Exports profile data (encrypted) for backup
     */
    async exportProfile(profileId: string): Promise<string> {
        if (!keyManager.isSessionActive() || keyManager.getProfileId() !== profileId) {
            throw new Error('Profile must be unlocked to export');
        }

        const profile = await prisma.profile.findUnique({
            where: { id: profileId },
            include: {
                memories: true,
            },
        });

        if (!profile) {
            throw new Error('Profile not found');
        }

        // Return encrypted backup
        const backup = {
            version: '1.0.0',
            exportedAt: new Date().toISOString(),
            profile,
        };

        return JSON.stringify(backup, null, 2);
    }
}

// Singleton instance
export const profileManager = new ProfileManager();



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\lib\profile\profile-schema.ts ---

/**
 * Profile Schema and Types
 * TypeScript interfaces for profile data structures
 */

export interface DigitalTwinProfile {
    id: string;
    name: string;
    createdAt: Date;
    updatedAt: Date;
    lastAccessedAt: Date;
    vectorNamespace: string;
}

export interface ProfileMetadata {
    preferences: {
        theme?: 'light' | 'dark' | 'auto';
        language?: string;
        timezone?: string;
    };
    settings: {
        autoLockTimeout?: number; // minutes
        enableBiometrics?: boolean;
    };
    createdBy: string;
    version: string;
}

export interface MemoryData {
    id: string;
    profileId: string;
    content: string; // Decrypted content
    metadata: {
        tags?: string[];
        context?: string;
        source?: string;
        [key: string]: any;
    };
    type: MemoryType;
    createdAt: Date;
    updatedAt: Date;
}

export enum MemoryType {
    TEXT = 'TEXT',
    IMAGE = 'IMAGE',
    VIDEO = 'VIDEO',
    AUDIO = 'AUDIO',
    DOCUMENT = 'DOCUMENT',
    CONVERSATION = 'CONVERSATION',
}

export interface VectorStoreConfig {
    provider: 'supabase-pgvector';
    namespace: string;
    dimension: number;
    model: string;
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\lib\security\crypto.ts ---

// lib/security/crypto.ts

// Pour faire simple dans ce prototype, on va dÃ©river une clÃ© Ã  partir d'un mot de passe fixe
// Dans une version prod, ce mot de passe serait demandÃ© Ã  l'utilisateur Ã  chaque session.
const MASTER_KEY_PASSWORD = "MON_SECRET_TRES_SECURISE_123";

async function getKey() {
    const enc = new TextEncoder();
    const keyMaterial = await window.crypto.subtle.importKey(
        "raw",
        enc.encode(MASTER_KEY_PASSWORD),
        { name: "PBKDF2" },
        false,
        ["deriveKey"]
    );

    return window.crypto.subtle.deriveKey(
        {
            name: "PBKDF2",
            salt: enc.encode("salt_fixe_pour_proto"), // Ã€ randomiser en prod
            iterations: 100000,
            hash: "SHA-256",
        },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        true,
        ["encrypt", "decrypt"]
    );
}

export const cryptoManager = {
    // CHIFFRER (Texte -> Charabia)
    async encrypt(text: string): Promise<string> {
        const key = await getKey();
        const iv = window.crypto.getRandomValues(new Uint8Array(12));
        const encoded = new TextEncoder().encode(text);

        const encrypted = await window.crypto.subtle.encrypt(
            { name: "AES-GCM", iv: iv },
            key,
            encoded
        );

        // On combine IV + Texte chiffrÃ© pour le stockage
        const ivArray = Array.from(iv);
        const encryptedArray = Array.from(new Uint8Array(encrypted));
        return JSON.stringify({ iv: ivArray, data: encryptedArray });
    },

    // DÃ‰CHIFFRER (Charabia -> Texte)
    async decrypt(cipherText: string): Promise<string> {
        try {
            const { iv, data } = JSON.parse(cipherText);
            const key = await getKey();

            const decrypted = await window.crypto.subtle.decrypt(
                { name: "AES-GCM", iv: new Uint8Array(iv) },
                key,
                new Uint8Array(data)
            );

            return new TextDecoder().decode(decrypted);
        } catch (e) {
            return "ðŸ”’ [Contenu VerrouillÃ© - ClÃ© invalide]";
        }
    }
};



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\lib\supabase\client.ts ---

import { createClient } from '@supabase/supabase-js';

// On rÃ©cupÃ¨re les clÃ©s dans les variables d'environnement
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseKey) {
    throw new Error("Il manque les clÃ©s Supabase dans le fichier .env !");
}

// On crÃ©e et exporte le client
export const supabase = createClient(supabaseUrl, supabaseKey);



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\lib\vector\embedding-service.ts ---

/**
 * Embedding Service
 * Generates vector embeddings for text using Mistral AI
 */

interface EmbeddingResponse {
    embedding: number[];
    model: string;
    tokens: number;
}

export class EmbeddingService {
    private apiKey: string;
    private model: string = 'mistral-embed';
    private dimension: number = 1024;

    constructor() {
        this.apiKey = process.env.MISTRAL_API_KEY || '';

        if (!this.apiKey) {
            console.warn('MISTRAL_API_KEY not set. Embedding generation will fail.');
        }
    }

    /**
     * Generates an embedding for the given text
     */
    async generateEmbedding(text: string): Promise<number[]> {
        if (!this.apiKey) {
            throw new Error('Mistral API key not configured');
        }

        try {
            const response = await fetch('https://api.mistral.ai/v1/embeddings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.apiKey}`,
                },
                body: JSON.stringify({
                    model: this.model,
                    input: text,
                    encoding_format: 'float',
                }),
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(`Mistral API error: ${error.error?.message || 'Unknown error'}`);
            }

            const data = await response.json();
            return data.data[0].embedding;
        } catch (error) {
            console.error('Failed to generate embedding:', error);
            throw error;
        }
    }

    /**
     * Generates embeddings for multiple texts in batch
     */
    async generateEmbeddings(texts: string[]): Promise<number[][]> {
        if (!this.apiKey) {
            throw new Error('Mistral API key not configured');
        }

        try {
            const response = await fetch('https://api.mistral.ai/v1/embeddings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.apiKey}`,
                },
                body: JSON.stringify({
                    model: this.model,
                    input: texts,
                    encoding_format: 'float',
                }),
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(`Mistral API error: ${error.error?.message || 'Unknown error'}`);
            }

            const data = await response.json();
            return data.data.map((item: any) => item.embedding);
        } catch (error) {
            console.error('Failed to generate embeddings:', error);
            throw error;
        }
    }

    /**
     * Gets the dimension of embeddings produced by this service
     */
    getDimension(): number {
        return this.dimension;
    }

    /**
     * Gets the model name being used
     */
    getModel(): string {
        return this.model;
    }
}

// Singleton instance
export const embeddingService = new EmbeddingService();



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\lib\vector\supabase-pgvector.ts ---

import { createClient } from '@supabase/supabase-js';

// Configuration
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

interface MemoryInput {
    content: string;
    embedding: number[];
    tags: string[];
    type?: string;
    profileId: string;
}

export interface MemoryQueryResult {
    id: string;
    content: string;
    similarity: number;
}

export class SupabasePgVectorStore {
    private client;

    constructor() {
        this.client = createClient(supabaseUrl, supabaseKey);
    }

    // AJOUT (Ingestion)
    async addMemory(memory: MemoryInput) {
        let safeType = memory.type || 'MEMORY';
        const safeTags = [...(memory.tags || [])];

        // SÃ©curitÃ© au cas oÃ¹ on retombe sur une base stricte un jour
        if (safeType === 'file_upload') {
            // On laisse passer file_upload maintenant que la base est libre
            // Mais on garde la logique de tag par sÃ©curitÃ©
            safeTags.push('file_upload');
        }

        const payload: any = {
            content: memory.content,
            tags: safeTags,
            type: safeType,
            "profileId": memory.profileId
        };

        if (memory.embedding && memory.embedding.length > 0) {
            payload.embedding = memory.embedding;
        }

        const { error } = await this.client
            .from('memories')
            .insert(payload);

        if (error) {
            console.error("Supabase Insert Error:", error);
            throw new Error(`Failed to upsert vector: ${error.message}`);
        }
    }

    // RECHERCHE (RAG)
    async query(vector: number[], filter: { profileId: string }): Promise<MemoryQueryResult[]> {

        // --- CORRECTION CRITIQUE ICI ---
        // On appelle la fonction SQL avec les noms de paramÃ¨tres EXACTS
        const { data, error } = await this.client.rpc('match_memories', {
            query_embedding: vector,
            match_threshold: 0.4,       // Seuil tolÃ©rant pour trouver le souvenir
            match_count: 5,
            query_profile_id: filter.profileId // <--- C'est la clÃ© du succÃ¨s !
        });

        if (error) {
            console.error("Supabase Search Error:", error);
            // On logue l'erreur mais on ne crash pas l'app, on renvoie une liste vide
            return [];
        }

        return (data || []).map((row: any) => ({
            id: row.id,
            content: row.content,
            similarity: row.similarity
        }));
    }

    // SUPPRESSION (Oubli)
    async deleteMemory(id: string) {
        const { error } = await this.client
            .from('memories')
            .delete()
            .eq('id', id);

        if (error) {
            console.error("Supabase Delete Error:", error);
            throw new Error(`Failed to delete memory: ${error.message}`);
        }
    }
}

export const vectorStore = new SupabasePgVectorStore();


--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\lib\vector\vector-store.ts ---

/**
 * Vector Store Interface
 * Abstraction layer for vector database operations with encryption support
 */

export interface VectorMetadata {
    profileId: string;
    memoryId: string;
    type: string;
    createdAt: string;
    [key: string]: any; // Additional encrypted metadata
}

export interface VectorSearchResult {
    id: string;
    score: number;
    metadata: VectorMetadata;
}

export interface VectorStore {
    /**
     * Inserts or updates a vector with metadata
     */
    upsert(
        id: string,
        embedding: number[],
        metadata: VectorMetadata
    ): Promise<void>;

    /**
     * Searches for similar vectors
     */
    query(
        embedding: number[],
        profileId: string,
        limit?: number
    ): Promise<VectorSearchResult[]>;

    /**
     * Deletes a vector by ID
     */
    delete(id: string): Promise<void>;

    /**
     * Deletes all vectors for a profile
     */
    deleteByProfile(profileId: string): Promise<void>;
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\prisma\schema.prisma ---

// Prisma Schema for Digital Twin Profile System
// Zero-Knowledge Architecture with Supabase pgvector

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [vector]
}

// Profile represents a digital twin instance
// Each profile is completely isolated with its own encryption
model Profile {
  id                String   @id @default(cuid())
  name              String   // Non-sensitive display name
  
  // Zero-Knowledge Security
  saltBase64        String   // Base64 encoded salt for key derivation
  passwordHash      String   // Hash for password verification (not the encryption key)
  
  // Encrypted Metadata (JSON)
  encryptedMetadata String   @db.Text // Contains encrypted profile settings, preferences, etc.
  
  // Vector Store Configuration
  vectorNamespace   String   @unique // Unique namespace for this profile's vectors
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  lastAccessedAt    DateTime @default(now())
  
  // Relations
  memories           Memory[]
  missions           Mission[]
  shadowInteractions ShadowInteraction[]
  dataSources        DataSource[]
  
  @@index([vectorNamespace])
}

// Memory represents a single memory/data point
// All content is encrypted before storage
model Memory {
  id                String   @id @default(cuid())
  
  // Profile Association (strict isolation)
  profileId         String
  profile           Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Encrypted Content
  encryptedContent  String   @db.Text // The actual memory content (encrypted)
  encryptedMetadata String   @db.Text // Additional metadata like tags, context (encrypted)
  
  // Vector Embedding (stored in pgvector)
  // The embedding itself is derived from encrypted content
  embedding         Unsupported("vector(1024)")?  // Mistral Embed dimension (optional for now)
  
  // Memory Type
  type              MemoryType @default(TEXT)
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([profileId])
  @@index([profileId, type])
  @@index([profileId, createdAt])
}

// Enum for memory types
enum MemoryType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  CONVERSATION
}

// Mission represents an autonomous task given to the Digital Twin
model Mission {
  id          String        @id @default(cuid())
  profileId   String
  profile     Profile       @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  title       String        // e.g., "Find investors"
  description String?       @db.Text
  status      MissionStatus @default(ACTIVE)
  progress    Int           @default(0) // 0-100
  
  // JSON log of actions taken
  log         String        @db.Text @default("[]")
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  completedAt DateTime?
  
  @@index([profileId])
  @@index([profileId, status])
}

// ShadowInteraction tracks the clone's autonomous network activity
model ShadowInteraction {
  id                String            @id @default(cuid())
  profileId         String
  profile           Profile           @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // The anonymous ID encountered in the network
  targetProfileId   String
  
  // AI-computed compatibility score
  compatibilityScore Float            @default(0.0)
  
  // Interaction status
  status            InteractionStatus @default(IGNORED)
  
  // Metadata about the interaction
  metadata          String            @db.Text @default("{}")
  
  timestamp         DateTime          @default(now())
  
  @@index([profileId])
  @@index([profileId, status])
  @@index([profileId, timestamp])
}

// Enum for mission status
enum MissionStatus {
  ACTIVE
  COMPLETED
  PAUSED
  FAILED
}

// Enum for shadow interaction status
enum InteractionStatus {
  IGNORED      // Clone ignored this profile
  MATCHED      // Clone found a match
  ESCALATED    // Requires human review
}

// DataSource represents a connected social media platform for data ingestion
// CRITICAL: Read-only. Twin NEVER posts to real social networks.
model DataSource {
  id          String     @id @default(cuid())
  profileId   String
  profile     Profile    @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  platform    String     // 'LINKEDIN', 'TWITTER', 'INSTAGRAM'
  isConnected Boolean    @default(false)
  syncStatus  SyncStatus @default(IDLE)
  
  lastSync    DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  @@index([profileId])
  @@index([profileId, platform])
  @@unique([profileId, platform])
}

// Enum for data source sync status
 enum SyncStatus {
  IDLE
  SYNCING
  CONNECTED
  ERROR
}

// Recovery Phrase Storage (optional - for BIP39 backup)
// This should be encrypted with a separate recovery key
model RecoveryPhrase {
  id                String   @id @default(cuid())
  profileId         String   @unique
  
  // Encrypted BIP39 phrase (encrypted with a recovery-specific key)
  encryptedPhrase   String   @db.Text
  
  // Verification hash to confirm recovery phrase without decrypting
  phraseHash        String
  
  createdAt         DateTime @default(now())
  
  @@index([profileId])
}



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\prisma\migrations\001_setup_pgvector.sql ---

-- SQL Migration for pgvector Setup
-- Run this in your Supabase SQL Editor or PostgreSQL database

-- Enable pgvector extension
CREATE EXTENSION IF NOT EXISTS vector;

-- Create function for semantic search with cosine similarity
-- This function is called by the Supabase pgvector adapter
CREATE OR REPLACE FUNCTION match_memories(
  query_embedding vector(1024),
  query_profile_id text,
  match_threshold float DEFAULT 0.7,
  match_count int DEFAULT 10
)
RETURNS TABLE (
  id text,
  profile_id text,
  encrypted_content text,
  encrypted_metadata text,
  type text,
  created_at timestamp,
  similarity float
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    "Memory".id,
    "Memory"."profileId" as profile_id,
    "Memory"."encryptedContent" as encrypted_content,
    "Memory"."encryptedMetadata" as encrypted_metadata,
    "Memory".type::text,
    "Memory"."createdAt" as created_at,
    1 - ("Memory".embedding <=> query_embedding) as similarity
  FROM "Memory"
  WHERE "Memory"."profileId" = query_profile_id
    AND 1 - ("Memory".embedding <=> query_embedding) > match_threshold
  ORDER BY "Memory".embedding <=> query_embedding
  LIMIT match_count;
END;
$$;

-- Create index on embedding column for faster similarity search
CREATE INDEX IF NOT EXISTS memory_embedding_idx 
ON "Memory" 
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- Create index on profileId for isolation queries
CREATE INDEX IF NOT EXISTS memory_profile_id_idx 
ON "Memory" ("profileId");

-- Create composite index for profile + type queries
CREATE INDEX IF NOT EXISTS memory_profile_type_idx 
ON "Memory" ("profileId", type);

-- Create index on createdAt for temporal queries
CREATE INDEX IF NOT EXISTS memory_created_at_idx 
ON "Memory" ("createdAt" DESC);

-- Enable Row Level Security (RLS) for additional protection
ALTER TABLE "Profile" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "Memory" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "RecoveryPhrase" ENABLE ROW LEVEL SECURITY;

-- Note: RLS policies should be configured based on your authentication setup
-- Example policy (adjust based on your auth system):
-- CREATE POLICY "Users can only access their own profiles"
--   ON "Profile"
--   FOR ALL
--   USING (auth.uid()::text = id);

COMMENT ON FUNCTION match_memories IS 'Performs semantic search on memories using pgvector cosine similarity, strictly filtered by profile ID for Zero-Knowledge isolation';
COMMENT ON INDEX memory_embedding_idx IS 'IVFFlat index for fast approximate nearest neighbor search on embeddings';



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\prisma\migrations\002_update_vector_dimension.sql ---

-- Migration: Update vector dimension from 1536 to 1024 for Mistral Embed
-- WARNING: This will clear existing embeddings
-- Run this migration AFTER updating your application code

-- Drop the old function
DROP FUNCTION IF EXISTS match_memories;

-- Alter the embedding column (this will clear existing data)
ALTER TABLE "Memory" 
ALTER COLUMN embedding TYPE vector(1024);

-- Recreate the function with new dimension
CREATE OR REPLACE FUNCTION match_memories(
  query_embedding vector(1024),
  query_profile_id text,
  match_threshold float DEFAULT 0.7,
  match_count int DEFAULT 10
)
RETURNS TABLE (
  id text,
  profile_id text,
  encrypted_content text,
  encrypted_metadata text,
  type text,
  created_at timestamp,
  similarity float
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    "Memory".id,
    "Memory"."profileId" as profile_id,
    "Memory"."encryptedContent" as encrypted_content,
    "Memory"."encryptedMetadata" as encrypted_metadata,
    "Memory".type::text,
    "Memory"."createdAt" as created_at,
    1 - ("Memory".embedding <=> query_embedding) as similarity
  FROM "Memory"
  WHERE "Memory"."profileId" = query_profile_id
    AND 1 - ("Memory".embedding <=> query_embedding) > match_threshold
  ORDER BY "Memory".embedding <=> query_embedding
  LIMIT match_count;
END;
$$;

-- Recreate index
DROP INDEX IF EXISTS memory_embedding_idx;
CREATE INDEX memory_embedding_idx 
ON "Memory" 
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

COMMENT ON FUNCTION match_memories IS 'Performs semantic search on memories using Mistral Embed (1024-dim) with pgvector cosine similarity, strictly filtered by profile ID for Zero-Knowledge isolation';



--- FILE: C:\Users\Frédéric\.gemini\antigravity\scratch\digital-twin-profile\scripts\init.js ---

#!/usr/bin/env node

/**
 * Initialization Script for Digital Twin Profile System
 * Run this after setting up your environment variables
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

console.log('ðŸš€ Initializing Digital Twin Profile System...\n');

// Check if .env.local exists
const envPath = path.join(__dirname, '..', '.env.local');
if (!fs.existsSync(envPath)) {
    console.error('âŒ Error: .env.local file not found!');
    console.log('ðŸ“ Please copy .env.example to .env.local and fill in your values:');
    console.log('   cp .env.example .env.local\n');
    process.exit(1);
}

console.log('âœ… Environment file found\n');

// Step 1: Generate Prisma Client
console.log('ðŸ“¦ Step 1: Generating Prisma Client...');
try {
    execSync('npx prisma generate', { stdio: 'inherit' });
    console.log('âœ… Prisma Client generated\n');
} catch (error) {
    console.error('âŒ Failed to generate Prisma Client');
    process.exit(1);
}

// Step 2: Push database schema
console.log('ðŸ—„ï¸  Step 2: Pushing database schema...');
try {
    execSync('npx prisma db push', { stdio: 'inherit' });
    console.log('âœ… Database schema pushed\n');
} catch (error) {
    console.error('âŒ Failed to push database schema');
    console.log('ðŸ’¡ Make sure your DATABASE_URL is correct in .env.local');
    process.exit(1);
}

// Step 3: Instructions for pgvector migration
console.log('ðŸ§  Step 3: pgvector Setup');
console.log('âš ï¸  MANUAL STEP REQUIRED:');
console.log('   1. Open your Supabase SQL Editor');
console.log('   2. Run the SQL from: prisma/migrations/001_setup_pgvector.sql');
console.log('   3. This will enable pgvector and create the semantic search function\n');

// Step 4: Verify installation
console.log('âœ… Core setup complete!\n');
console.log('ðŸ“‹ Next steps:');
console.log('   1. Complete the pgvector migration (see Step 3 above)');
console.log('   2. Run: npm run dev');
console.log('   3. Navigate to: http://localhost:3000/profile/new');
console.log('   4. Create your first digital twin profile!\n');

console.log('ðŸ” Security Reminder:');
console.log('   - Your master password is NEVER stored on the server');
console.log('   - Save your BIP39 recovery phrase in a safe place');
console.log('   - Loss of both = permanent data loss\n');

console.log('ðŸŽ‰ Happy coding!\n');



